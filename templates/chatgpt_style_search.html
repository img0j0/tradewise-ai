<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TradeWise AI - Stock Search</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/premium_features.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tier_styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/enhanced_front_page.css') }}">
    <style>
        /* Enhanced Brand Animation Styles */
        .animated-brand {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 25%, #8b5cf6 50%, #ec4899 75%, #60a5fa 100%);
            background-size: 300% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 6s ease-in-out infinite;
            font-weight: 900;
            font-size: 2.2rem;
            letter-spacing: -1px;
            text-shadow: 0 0 40px rgba(96, 165, 250, 0.3);
            position: relative;
            line-height: 1;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            text-align: left;
            align-self: flex-start;
            display: block;
            width: 100%;
        }

        @keyframes shimmer {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .brand-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            animation: brandFadeIn 1.2s ease-out;
            flex-grow: 1;
            padding: 0.5rem 0;
        }

        @keyframes brandFadeIn {
            0% {
                opacity: 0;
                transform: translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero-tagline {
            font-size: 0.85rem;
            background: linear-gradient(135deg, #60a5fa, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            letter-spacing: 0.3px;
            text-transform: uppercase;
            text-align: center;
            margin-bottom: 0.5rem;
            opacity: 0;
            animation: taglineFadeIn 1s ease-out 0.4s forwards;
        }

        /* Crown Upgrade Button */
        .crown-upgrade-button {
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #d97706);
            border: none;
            border-radius: 16px;
            padding: 0.75rem;
            color: white !important;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 16px rgba(251, 191, 36, 0.4), 0 0 0 1px rgba(251, 191, 36, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 52px;
            height: 52px;
            align-items: center;
            justify-content: center;
            width: 52px;
            height: 52px;
            position: relative;
            overflow: hidden;
        }
        
        .crown-upgrade-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }

        .crown-upgrade-button:hover {
            background: linear-gradient(135deg, #f59e0b, #d97706, #92400e);
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.5), 0 0 0 1px rgba(251, 191, 36, 0.2);
        }
        
        .crown-upgrade-button:hover::before {
            left: 100%;
        }

        .crown-upgrade-button:active {
            transform: translateY(-1px) scale(1.02);
        }

        .crown-upgrade-button i {
            font-size: 1.3rem !important;
            color: white !important;
            animation: crownPulse 4s ease-in-out infinite;
            filter: drop-shadow(0 0 8px rgba(255,255,255,0.3));
            display: block !important;
        }

        @keyframes crownPulse {
            0%, 100% { 
                transform: scale(1);
                filter: drop-shadow(0 0 8px rgba(255,255,255,0.3));
            }
            50% { 
                transform: scale(1.1);
                filter: drop-shadow(0 0 12px rgba(255,255,255,0.5));
            }
        }

        @keyframes taglineFadeIn {
            0% {
                opacity: 0;
                transform: translateY(5px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Enhanced header styling */
        .header {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1.2rem 1.5rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        /* Subtle glow effect on hover */
        .brand-container:hover .animated-brand {
            animation: shimmerHover 3s ease-in-out infinite;
            text-shadow: 0 0 50px rgba(96, 165, 250, 0.6);
            transform: scale(1.02);
        }

        @keyframes shimmerHover {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        /* Mobile responsive adjustments */
        @media (max-width: 768px) {
            .animated-brand {
                font-size: 1.8rem;
                letter-spacing: -0.8px;
            }
            .hero-tagline {
                font-size: 0.75rem;
            }
            .crown-upgrade-button {
                width: 46px;
                height: 46px;
                padding: 0.65rem;
            }
            .crown-upgrade-button i {
                font-size: 1.1rem;
            }
            .header {
                padding: 1rem 1.2rem;
            }
        }
        
        /* Enhanced search interface */
        .main-content {
            padding-top: 3rem;
        }
        
        .search-container {
            margin-bottom: 2rem;
            text-align: center;
        }
        
        /* Search Hero Section */
        .search-hero {
            margin-bottom: 3rem;
            padding: 2rem 1rem;
        }
        
        .search-hero-title {
            font-size: 3.5rem;
            font-weight: 800;
            margin-bottom: 1rem;
            line-height: 1.1;
        }
        
        .hero-gradient {
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 25%, #8b5cf6 50%, #ec4899 75%, #f59e0b 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: heroShimmer 8s ease-in-out infinite;
        }
        
        @keyframes heroShimmer {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .search-hero-subtitle {
            font-size: 1.25rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto 2rem;
            line-height: 1.5;
        }
        
        /* Enhanced Search Input */
        .search-input-container.enhanced {
            background: rgba(255, 255, 255, 0.08);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 1.25rem 1.5rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(30px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            margin: 0 auto;
            position: relative;
            overflow: hidden;
        }
        
        .search-input-container.enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.1), transparent);
            transition: left 0.8s;
        }
        
        .search-input-container.enhanced:focus-within {
            border-color: rgba(96, 165, 250, 0.6);
            box-shadow: 0 0 0 4px rgba(96, 165, 250, 0.1), 0 12px 40px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.12);
        }
        
        .search-input-container.enhanced:focus-within::before {
            left: 100%;
        }
        
        .search-input.enhanced {
            font-size: 1.1rem;
            font-weight: 500;
            color: white;
            background: transparent;
            border: none;
            outline: none;
            width: 100%;
            padding: 0.5rem 80px 0.5rem 0;
        }
        
        .search-input.enhanced::placeholder {
            color: rgba(255, 255, 255, 0.6);
            font-weight: 400;
        }
        
        .ai-indicator.enhanced {
            background: linear-gradient(135deg, #60a5fa, #8b5cf6);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 700;
            box-shadow: 0 4px 16px rgba(96, 165, 250, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .ai-pulse {
            position: absolute;
            top: 50%;
            left: 0.5rem;
            width: 8px;
            height: 8px;
            background: #00ff88;
            border-radius: 50%;
            transform: translateY(-50%);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: translateY(-50%) scale(1); }
            50% { opacity: 0.7; transform: translateY(-50%) scale(1.2); }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/tier_integration.js') }}"></script>
</head>
<body>
    <!-- ChatGPT-Style Interface -->
    <div class="chatgpt-container">
        <!-- Header -->
        <div class="header">
            <div class="header-left">
                <div class="brand-container">
                    <span class="brand-name animated-brand">TradeWise AI</span>
                </div>
            </div>
            <div class="header-right">
                <button class="crown-upgrade-button" id="upgrade-button" onclick="window.location.href='/subscription'" title="Upgrade to Premium">
                    <i class="fas fa-crown"></i>
                </button>
                <div class="tools-dropdown">
                    <button class="tools-toggle-compact" onclick="toggleToolsDropdown()">
                        <i class="fas fa-tools"></i>
                        <span class="tools-text">Tools</span>
                        <i class="fas fa-chevron-down tools-chevron"></i>
                    </button>
                    <div class="tools-dropdown-menu" id="tools-dropdown-menu">
                        <!-- Market Intelligence -->
                        <div class="dropdown-item market-intelligence-toggle" onclick="toggleMarketIntelligence()">
                            <i class="fas fa-brain" style="color: #00d4ff;"></i>
                            <span>Market Intelligence</span>
                            <div class="live-indicator" style="margin-left: auto; display: flex; align-items: center;">
                                <div class="pulse-dot" style="width: 6px; height: 6px; background: #00ff88; border-radius: 50%; margin-right: 5px; animation: pulse 2s infinite;"></div>
                                <span style="color: #00ff88; font-size: 10px; font-weight: 500;">LIVE</span>
                            </div>
                        </div>
                        
                        <!-- Market Intelligence Content (Initially Hidden) -->
                        <div id="market-intelligence-content" style="display: none; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 10px; margin: 10px 0; max-width: 350px; max-height: 400px; overflow-y: auto; overscroll-behavior: contain;">
                            {% include 'market_intelligence_widget.html' %}
                        </div>
                        
                        <div class="dropdown-item" onclick="togglePortfolio()">
                            <i class="fas fa-wallet"></i>
                            <span>Portfolio</span>
                        </div>
                        <div class="dropdown-item" onclick="openInstitutionalContact()">
                            <i class="fas fa-university"></i>
                            <span>Institutional Contact</span>
                        </div>
                        <div class="dropdown-item" onclick="openSettings()">
                            <i class="fas fa-user-cog"></i>
                            <span>Account Settings</span>
                        </div>
                        <div class="dropdown-item" onclick="openSubscriptionPlans()">
                            <i class="fas fa-star"></i>
                            <span>Subscription Plans</span>
                        </div>
                        <div class="dropdown-item" onclick="showTradingHistory()">
                            <i class="fas fa-history"></i>
                            <span>Trading History</span>
                        </div>
                        <div class="dropdown-item" onclick="showWatchlist()">
                            <i class="fas fa-eye"></i>
                            <span>Watchlist</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Notification Area -->
        <div id="notification-area"></div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Enhanced Portfolio Section -->
            <div id="portfolio-section" class="portfolio-section" style="display: none;">
                <div class="portfolio-header">
                    <h3><i class="fas fa-chart-line" style="font-size: 1.1rem;"></i> Your Portfolio</h3>
                    <button class="close-portfolio" onclick="togglePortfolio()">
                        <i class="fas fa-times" style="font-size: 0.9rem;"></i>
                    </button>
                </div>
                
                <!-- Enhanced Portfolio Overview Cards -->
                <div class="enhanced-portfolio-overview" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                    <div class="enhanced-portfolio-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 15px; backdrop-filter: blur(10px); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #3b82f6, #8b5cf6);"></div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                                <i class="fas fa-dollar-sign" style="color: white; font-size: 0.9rem;"></i>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6);">Total Value</div>
                                <div style="font-size: 1.2rem; font-weight: 700;" id="enhanced-total-value">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="enhanced-portfolio-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 15px; backdrop-filter: blur(10px); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #8b5cf6, #7c3aed);"></div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                                <i class="fas fa-coins" style="color: white; font-size: 0.9rem;"></i>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6);">Total Invested</div>
                                <div style="font-size: 1.2rem; font-weight: 700;" id="enhanced-total-invested">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="enhanced-portfolio-card" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 15px; backdrop-filter: blur(10px); position: relative; overflow: hidden;">
                        <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #10b981, #059669);"></div>
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <div style="width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #10b981, #059669);">
                                <i class="fas fa-trending-up" style="color: white; font-size: 0.9rem;"></i>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: rgba(255, 255, 255, 0.6);">Total Return</div>
                                <div style="font-size: 1.2rem; font-weight: 700;" id="enhanced-total-return">$0.00</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Holdings Section -->
                <div class="enhanced-holdings-section" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 15px; backdrop-filter: blur(10px); margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                        <h4 style="font-size: 1.1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; margin: 0;">
                            <i class="fas fa-briefcase"></i>
                            Your Holdings
                        </h4>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: none; color: white; padding: 6px 12px; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.8rem;" onclick="showDepositModal()">
                                <i class="fas fa-plus"></i>
                                Add Funds
                            </button>
                            <button style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); border: none; color: white; padding: 6px 12px; border-radius: 8px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 6px; font-size: 0.8rem;" onclick="showBuyModal()">
                                <i class="fas fa-shopping-cart"></i>
                                Buy Stock
                            </button>
                        </div>
                    </div>

                    <div id="enhanced-holdings-container">
                        <!-- Loading state -->
                        <div style="text-align: center; padding: 20px;" id="enhanced-portfolio-loading">
                            <div style="width: 24px; height: 24px; border: 2px solid rgba(255, 255, 255, 0.1); border-top: 2px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                            <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem;">Loading your portfolio...</p>
                        </div>

                        <!-- Empty state -->
                        <div style="text-align: center; padding: 30px 15px; color: rgba(255, 255, 255, 0.7); display: none;" id="enhanced-portfolio-empty">
                            <i class="fas fa-chart-pie" style="font-size: 2.5rem; margin-bottom: 12px; color: rgba(255, 255, 255, 0.3);"></i>
                            <h5 style="margin-bottom: 8px; color: rgba(255, 255, 255, 0.8);">Start Building Your Portfolio</h5>
                            <p style="margin-bottom: 15px; font-size: 0.9rem;">Search for stocks above to begin building your personalized portfolio with AI guidance.</p>
                            <button style="background: linear-gradient(135deg, #3b82f6, #1d4ed8); border: none; color: white; padding: 6px 12px; border-radius: 8px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; font-size: 0.8rem;" onclick="togglePortfolio()">
                                <i class="fas fa-search"></i>
                                Search Stocks
                            </button>
                        </div>

                        <!-- Holdings will be populated here -->
                        <div id="enhanced-holdings-grid" style="display: grid; gap: 10px; display: none;">
                            <!-- Holdings items will be dynamically inserted -->
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced AI Portfolio Builder Section -->
                <div class="enhanced-ai-builder-section" style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px); margin-bottom: 20px; position: relative; overflow: hidden;">
                    <!-- Gradient accent -->
                    <div style="position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, #60a5fa, #8b5cf6, #10b981);"></div>
                    
                    <!-- Header section -->
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="display: inline-flex; align-items: center; justify-content: center; width: 48px; height: 48px; border-radius: 12px; background: linear-gradient(135deg, #60a5fa, #8b5cf6); margin-bottom: 12px;">
                            <i class="fas fa-robot" style="color: white; font-size: 1.5rem;"></i>
                        </div>
                        <h4 style="font-size: 1.2rem; font-weight: 600; margin-bottom: 8px; background: linear-gradient(135deg, #60a5fa, #8b5cf6); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            AI Portfolio Builder
                        </h4>
                        <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.9rem; margin: 0; max-width: 300px; margin-left: auto; margin-right: auto;">
                            Let our AI create a personalized portfolio based on your goals and risk tolerance
                        </p>
                    </div>
                    
                    <!-- Action buttons grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                        <button style="background: linear-gradient(135deg, #60a5fa, #3b82f6); border: none; color: white; padding: 12px 16px; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; transition: transform 0.2s ease, box-shadow 0.2s ease;" 
                                onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 12px rgba(96, 165, 250, 0.3)'"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'"
                                onclick="startPortfolioQuestionnaire()">
                            <i class="fas fa-magic"></i>
                            Build Portfolio
                        </button>
                        <button style="background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: white; padding: 12px 16px; border-radius: 10px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; transition: all 0.2s ease;" 
                                onmouseover="this.style.background='rgba(255, 255, 255, 0.15)'; this.style.transform='translateY(-1px)'"
                                onmouseout="this.style.background='rgba(255, 255, 255, 0.1)'; this.style.transform='translateY(0)'"
                                onclick="showPortfolioStrategies()">
                            <i class="fas fa-list"></i>
                            View Strategies
                        </button>
                    </div>
                    
                    <!-- Quick stats -->
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; font-size: 0.8rem;">
                            <div style="text-align: center;">
                                <div style="color: rgba(255, 255, 255, 0.5);">AI Accuracy</div>
                                <div style="font-weight: 600; color: #10b981;">87.3%</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: rgba(255, 255, 255, 0.5);">Strategies</div>
                                <div style="font-weight: 600; color: #60a5fa;">5 Types</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: rgba(255, 255, 255, 0.5);">Risk Levels</div>
                                <div style="font-weight: 600; color: #8b5cf6;">All Covered</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- AI Copilot Condensed Indicator (for premium users) -->
            <div id="ai-copilot-condensed" class="ai-copilot-condensed" style="display: none;">
                <div class="copilot-indicator" onclick="toggleCopilotExpanded()">
                    <div class="indicator-left">
                        <i class="fas fa-robot robot-icon-pulse" style="color: #60a5fa; font-size: 1rem;"></i>
                        <span class="copilot-status">AI Copilot</span>
                        <span class="copilot-badge">ACTIVE</span>
                        <span class="signal-count" id="signal-count-indicator">2 signals</span>
                    </div>
                    <div class="indicator-right">
                        <i class="fas fa-chevron-down expand-icon" id="copilot-expand-icon"></i>
                    </div>
                </div>
                
                <!-- Expanded Copilot Content (hidden by default) -->
                <div id="copilot-expanded-content" class="copilot-expanded-content" style="display: none;">
                    <div id="copilot-signals" class="copilot-signals">
                        <div class="text-center text-muted p-3">
                            <i class="fas fa-spinner fa-spin mb-2" style="color: #60a5fa; font-size: 1rem;"></i>
                            <p class="mb-0" style="color: #888; font-size: 0.9rem;">AI scanning markets...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Compact Search Header -->
            <div class="search-hero-compact">
                <div class="hero-tagline">AI-Powered Trading</div>
                <h3 class="search-title-compact">
                    <span class="hero-gradient">Discover</span> Your Next Investment
                </h3>
                <p class="search-subtitle-compact">AI-powered insights for any stock, crypto, or ETF</p>
            </div>
            
            <!-- Stock Search Content (default view) -->
            <div id="search-content" class="search-content">
                <!-- Popular Stocks Dropdown -->
                <div class="popular-stocks-condensed dropdown-container">
                    <div class="popular-indicator" onclick="togglePopularExpanded()">
                        <div class="popular-left">
                            <i class="fas fa-star" style="color: #60a5fa; font-size: 0.9rem;"></i>
                            <span class="popular-label">Popular Stocks</span>
                            <div class="popular-pills">
                                <span class="popular-pill trending">Trending</span>
                                <span class="popular-pill growth">Growth</span>
                                <span class="popular-pill tech">Tech</span>
                            </div>
                        </div>
                        <div class="popular-right">
                            <i class="fas fa-chevron-down expand-icon" id="popular-expand-icon"></i>
                        </div>
                    </div>
                    
                    <!-- Expanded Popular Stocks Content -->
                    <div id="popular-expanded-content" class="popular-expanded-content" style="display: none;">
                        <div class="popular-grid">
                            <button class="popular-stock-card" onclick="searchStock('AAPL')">
                                <div class="stock-symbol">AAPL</div>
                                <div class="stock-name">Apple Inc.</div>
                                <div class="stock-price">$180.25</div>
                            </button>
                            <button class="popular-stock-card" onclick="searchStock('TSLA')">
                                <div class="stock-symbol">TSLA</div>
                                <div class="stock-name">Tesla Inc.</div>
                                <div class="stock-price">$245.67</div>
                            </button>
                            <button class="popular-stock-card" onclick="searchStock('NVDA')">
                                <div class="stock-symbol">NVDA</div>
                                <div class="stock-name">NVIDIA Corp.</div>
                                <div class="stock-price">$425.89</div>
                            </button>
                            <button class="popular-stock-card" onclick="searchStock('MSFT')">
                                <div class="stock-symbol">MSFT</div>
                                <div class="stock-name">Microsoft Corp.</div>
                                <div class="stock-price">$385.21</div>
                            </button>
                            <button class="popular-stock-card" onclick="searchStock('GOOGL')">
                                <div class="stock-symbol">GOOGL</div>
                                <div class="stock-name">Alphabet Inc.</div>
                                <div class="stock-price">$142.55</div>
                            </button>
                            <button class="popular-stock-card" onclick="searchStock('AMZN')">
                                <div class="stock-symbol">AMZN</div>
                                <div class="stock-name">Amazon.com Inc.</div>
                                <div class="stock-price">$155.73</div>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Condensed Investment Themes -->
                <div class="investment-themes-condensed dropdown-container">
                    <div class="themes-indicator" onclick="toggleThemesExpanded()">
                        <div class="themes-left">
                            <i class="fas fa-chart-pie" style="color: #60a5fa; font-size: 0.9rem;"></i>
                            <span class="themes-label">Investment Themes</span>
                            <div class="theme-pills">
                                <span class="theme-pill" onclick="event.stopPropagation(); searchStock('NVDA')">AI</span>
                                <span class="theme-pill" onclick="event.stopPropagation(); searchStock('TSLA')">EV</span>
                                <span class="theme-pill" onclick="event.stopPropagation(); searchStock('AAPL')">Blue Chip</span>
                                <span class="theme-pill" onclick="event.stopPropagation(); searchTheme('ESG')">ESG</span>
                                <span class="theme-pill-more">+9 more</span>
                            </div>
                        </div>
                        <div class="themes-right">
                            <i class="fas fa-chevron-down expand-icon" id="themes-expand-icon"></i>
                        </div>
                    </div>
                    
                    <!-- Expanded Themes Content (hidden by default) -->
                    <div id="themes-expanded-content" class="themes-expanded-content" style="display: none;">
                        <div class="suggestion-cards">
                            <div class="suggestion-card ai-theme" onclick="searchTheme('AI')">
                                <div class="card-icon"><i class="fas fa-robot"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Artificial Intelligence</div>
                                    <div class="card-subtitle">Next-gen tech revolutionizing industries</div>
                                    <div class="card-performance">+127% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card ev-theme" onclick="searchTheme('EV')">
                                <div class="card-icon"><i class="fas fa-car-battery"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Electric Vehicles</div>
                                    <div class="card-subtitle">Sustainable transportation leaders</div>
                                    <div class="card-performance">+89% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card crypto-theme" onclick="searchTheme('Crypto')">
                                <div class="card-icon"><i class="fas fa-coins"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Cryptocurrency</div>
                                    <div class="card-subtitle">Digital asset ecosystem</div>
                                    <div class="card-performance">+156% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card biotech-theme" onclick="searchTheme('Biotech')">
                                <div class="card-icon"><i class="fas fa-dna"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Biotechnology</div>
                                    <div class="card-subtitle">Healthcare innovation pipeline</div>
                                    <div class="card-performance">+67% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card fintech-theme" onclick="searchTheme('Fintech')">
                                <div class="card-icon"><i class="fas fa-credit-card"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Financial Technology</div>
                                    <div class="card-subtitle">Digital banking revolution</div>
                                    <div class="card-performance">+45% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card cloud-theme" onclick="searchTheme('Cloud')">
                                <div class="card-icon"><i class="fas fa-cloud"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Cloud Computing</div>
                                    <div class="card-subtitle">Enterprise digital transformation</div>
                                    <div class="card-performance">+78% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card space-theme" onclick="searchTheme('Space')">
                                <div class="card-icon"><i class="fas fa-rocket"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Space Technology</div>
                                    <div class="card-subtitle">Commercial space exploration</div>
                                    <div class="card-performance">+112% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card energy-theme" onclick="searchTheme('CleanEnergy')">
                                <div class="card-icon"><i class="fas fa-solar-panel"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Clean Energy</div>
                                    <div class="card-subtitle">Renewable power infrastructure</div>
                                    <div class="card-performance">+92% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card gaming-theme" onclick="searchTheme('Gaming')">
                                <div class="card-icon"><i class="fas fa-gamepad"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Gaming & Esports</div>
                                    <div class="card-subtitle">Interactive entertainment growth</div>
                                    <div class="card-performance">+34% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card esg-theme" onclick="searchTheme('ESG')">
                                <div class="card-icon"><i class="fas fa-leaf"></i></div>
                                <div class="card-content">
                                    <div class="card-title">ESG Investing</div>
                                    <div class="card-subtitle">Sustainable & responsible companies</div>
                                    <div class="card-performance">+56% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card defensive-theme" onclick="searchTheme('Defensive')">
                                <div class="card-icon"><i class="fas fa-shield-alt"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Defensive Stocks</div>
                                    <div class="card-subtitle">Stable dividend-paying companies</div>
                                    <div class="card-performance">+23% YTD</div>
                                </div>
                            </div>
                            <div class="suggestion-card emerging-theme" onclick="searchTheme('Emerging')">
                                <div class="card-icon"><i class="fas fa-globe-asia"></i></div>
                                <div class="card-content">
                                    <div class="card-title">Emerging Markets</div>
                                    <div class="card-subtitle">High-growth developing economies</div>
                                    <div class="card-performance">+43% YTD</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Market Insights Dropdown -->
                <div class="market-insights-condensed dropdown-container">
                    <div class="insights-indicator" onclick="toggleInsightsExpanded()">
                        <div class="insights-left">
                            <i class="fas fa-chart-line" style="color: #60a5fa; font-size: 0.9rem;"></i>
                            <span class="insights-label">Market Insights</span>
                            <div class="insight-pills">
                                <span class="insight-pill live">Live</span>
                                <span class="insight-pill trend">Trending</span>
                                <span class="insight-pill risk">Risk Alert</span>
                            </div>
                        </div>
                        <div class="insights-right">
                            <i class="fas fa-chevron-down expand-icon" id="insights-expand-icon"></i>
                        </div>
                    </div>
                    
                    <!-- Expanded Insights Content -->
                    <div id="insights-expanded-content" class="insights-expanded-content" style="display: none;">
                        <div class="insight-cards">
                            <div class="insight-card market-card">
                                <div class="insight-header">
                                    <i class="fas fa-chart-area"></i>
                                    <span>Market Overview</span>
                                    <span class="live-indicator">LIVE</span>
                                </div>
                                <div class="insight-content">
                                    <div class="market-stats">
                                        <div class="stat">
                                            <span class="stat-label">S&P 500</span>
                                            <span class="stat-value positive">+0.8%</span>
                                        </div>
                                        <div class="stat">
                                            <span class="stat-label">NASDAQ</span>
                                            <span class="stat-value positive">+1.2%</span>
                                        </div>
                                        <div class="stat">
                                            <span class="stat-label">VIX</span>
                                            <span class="stat-value neutral">16.4</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="insight-card trending-card">
                                <div class="insight-header">
                                    <i class="fas fa-fire"></i>
                                    <span>Trending Now</span>
                                    <span class="trend-indicator">HOT</span>
                                </div>
                                <div class="insight-content">
                                    <div class="trending-list">
                                        <div class="trending-item" onclick="searchStock('NVDA')">
                                            <span class="symbol">NVDA</span>
                                            <span class="trend-change">+8.7%</span>
                                        </div>
                                        <div class="trending-item" onclick="searchStock('TSLA')">
                                            <span class="symbol">TSLA</span>
                                            <span class="trend-change">+5.2%</span>
                                        </div>
                                        <div class="trending-item" onclick="searchStock('AAPL')">
                                            <span class="symbol">AAPL</span>
                                            <span class="trend-change">+2.1%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="insight-card ai-card">
                                <div class="insight-header">
                                    <i class="fas fa-brain"></i>
                                    <span>AI Predictions</span>
                                    <span class="confidence-indicator">89% confident</span>
                                </div>
                                <div class="insight-content">
                                    <div class="prediction-text">
                                        Tech sector showing strong momentum. AI-driven stocks expected to outperform through Q4.
                                    </div>
                                </div>
                            </div>
                            
                            <div class="insight-card risk-card">
                                <div class="insight-header">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>Risk Alerts</span>
                                    <span class="risk-indicator">2 active</span>
                                </div>
                                <div class="insight-content">
                                    <div class="risk-list">
                                        <div class="risk-item moderate">
                                            <span class="risk-text">Bond yields rising - monitor duration risk</span>
                                        </div>
                                        <div class="risk-item low">
                                            <span class="risk-text">Crypto volatility elevated this week</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Search Suggestions -->
                <div id="search-suggestions" class="search-suggestions">
                    <!-- Dynamic suggestions will appear here -->
                </div>
                
                <!-- Search Results Area -->
                <div id="search-results" class="search-results">
                    <!-- Results will appear here -->
                </div>
            </div>
        </div>
        
        <!-- Watchlist Modal -->
        <div id="watchlistModal" class="watchlist-modal">
            <div class="watchlist-modal-content">
                <div class="watchlist-modal-header">
                    <h3><i class="fas fa-list"></i> Smart Watchlist</h3>
                    <button class="watchlist-close-btn" onclick="closeWatchlistModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="watchlist-modal-body">
                    <div id="watchlistContainer">
                        <!-- Watchlists will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Bottom Input Area -->
        <div class="input-area">
            <div class="input-container">
                <input type="text" 
                       id="stock-search-input"
                       placeholder="Ask anything about stocks... (try 'google', 'apple', or 'NVDA')"
                       class="search-input"
                       onkeypress="handleEnterPress(event)"
                       oninput="showSearchSuggestions(this.value)">
                <button class="submit-btn" onclick="performSearch()">
                    <i class="fas fa-arrow-up" style="font-size: 0.9rem;"></i>
                </button>
            </div>
        </div>
        
        <!-- Fixed Subscription Status (Bottom Right) -->
        <div class="subscription-status-fixed">
            <span class="status-text">Free Features: Basic</span>
        </div>
    </div>

    <style>
    /* ChatGPT-Style Mobile Interface */
    .chatgpt-container {
        min-height: 100vh;
        background: #0A0B0F;
        color: white;
        display: flex;
        flex-direction: column;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    .header {
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        position: sticky;
        top: 0;
        background: #0A0B0F;
        z-index: 100;
    }

    .header-title {
        font-size: 1.25rem;
        font-weight: 600;
        background: linear-gradient(135deg, #00D4AA, #007AFF);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .upgrade-button-seamless {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(245, 158, 11, 0.1);
        border: 1px solid rgba(245, 158, 11, 0.3);
        border-radius: 25px;
        color: #f59e0b;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .upgrade-button-seamless:hover {
        background: rgba(245, 158, 11, 0.2);
        border-color: rgba(245, 158, 11, 0.5);
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(245, 158, 11, 0.2);
    }
    
    .upgrade-button-seamless i {
        color: #f59e0b;
    }

    .portfolio-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        color: white;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .portfolio-toggle:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
    }

    .portfolio-text {
        font-weight: 500;
    }

    /* Tools Dropdown Styling */
    .tools-dropdown {
        position: relative;
        display: inline-block;
    }

    .tools-toggle {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        color: white;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .tools-toggle:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
        color: white;
        text-decoration: none;
    }

    .tools-text {
        font-weight: 500;
    }

    .tools-dropdown-menu {
        position: absolute;
        top: 100%;
        right: 0;
        background: rgba(20, 20, 30, 0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        min-width: 200px;
        max-width: 400px;
        max-height: 80vh;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        z-index: 1000;
        margin-top: 0.5rem;
        display: none;
        overflow-y: auto;
        overscroll-behavior: contain;
        scroll-behavior: smooth;
    }

    .tools-dropdown-menu.show {
        display: block;
        animation: dropdownSlide 0.3s ease-out;
    }

    @keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .dropdown-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-size: 0.9rem;
    }

    .dropdown-item:last-child {
        border-bottom: none;
    }

    .dropdown-item:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #60a5fa;
    }

    .dropdown-item i {
        width: 16px;
        text-align: center;
        opacity: 0.8;
    }

    .dropdown-item:hover i {
        opacity: 1;
        color: #60a5fa;
    }

    .portfolio-value {
        font-weight: 600;
        color: #00D4AA;
    }

    /* Condensed AI Copilot Styling */
    .ai-copilot-condensed {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        border: 1px solid rgba(96, 165, 250, 0.2);
        margin-bottom: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .copilot-indicator {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        cursor: pointer;
        background: rgba(96, 165, 250, 0.05);
        transition: all 0.3s ease;
    }

    .copilot-indicator:hover {
        background: rgba(96, 165, 250, 0.08);
    }

    .indicator-left {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .robot-icon-pulse {
        animation: pulse-glow 2s infinite;
    }

    @keyframes pulse-glow {
        0%, 100% {
            text-shadow: 0 0 5px rgba(96, 165, 250, 0.5);
        }
        50% {
            text-shadow: 0 0 15px rgba(96, 165, 250, 0.8);
        }
    }

    .copilot-status {
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .copilot-badge {
        background: rgba(96, 165, 250, 0.8);
        color: white;
        padding: 0.15rem 0.5rem;
        border-radius: 10px;
        font-size: 0.7rem;
        font-weight: 600;
    }

    .signal-count {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.8rem;
    }

    .expand-icon {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8rem;
        transition: transform 0.3s ease;
    }

    .expand-icon.expanded {
        transform: rotate(180deg);
    }

    .copilot-expanded-content {
        padding: 0 1rem 1rem 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            max-height: 500px;
            transform: translateY(0);
        }
    }

    /* Mobile optimization for condensed copilot */
    @media (max-width: 768px) {
        .copilot-indicator {
            padding: 0.6rem 0.8rem;
        }
        
        .indicator-left {
            gap: 0.4rem;
        }
        
        .copilot-status {
            font-size: 0.85rem;
        }
        
        .signal-count {
            font-size: 0.75rem;
        }
    }

    /* Condensed Investment Themes Styling */
    .investment-themes-condensed {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        border: 1px solid rgba(96, 165, 250, 0.15);
        margin-bottom: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .themes-indicator {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        cursor: pointer;
        background: rgba(96, 165, 250, 0.03);
        transition: all 0.3s ease;
    }

    .themes-indicator:hover {
        background: rgba(96, 165, 250, 0.06);
    }

    .themes-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .themes-label {
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .theme-pills {
        display: flex;
        gap: 0.5rem;
        margin-left: 0.5rem;
    }

    .theme-pill {
        background: rgba(96, 165, 250, 0.2);
        color: white;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid rgba(96, 165, 250, 0.3);
    }

    .theme-pill:hover {
        background: rgba(96, 165, 250, 0.3);
        transform: translateY(-1px);
    }

    .themes-right {
        margin-left: auto;
    }

    .themes-expanded-content {
        padding: 0 1rem 1rem 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        animation: slideDown 0.3s ease-out;
    }

    .themes-expanded-content .suggestion-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 0.75rem;
        margin-top: 0.75rem;
    }

    .themes-expanded-content .suggestion-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .themes-expanded-content .suggestion-card:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .themes-expanded-content .card-title {
        color: white;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.3rem;
    }

    .themes-expanded-content .card-subtitle {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.75rem;
        line-height: 1.3;
    }

    /* Enhanced Theme Cards Styling */
    .themes-expanded-content .suggestion-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 0.75rem;
        padding: 1rem;
        max-height: 400px;
        overflow-y: auto;
    }

    .themes-expanded-content .suggestion-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(96, 165, 250, 0.1);
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        position: relative;
        overflow: hidden;
        text-align: left;
    }

    .themes-expanded-content .suggestion-card:before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 2px;
        background: linear-gradient(90deg, #00D4AA, #007AFF);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .themes-expanded-content .suggestion-card:hover {
        background: rgba(96, 165, 250, 0.05);
        border-color: rgba(96, 165, 250, 0.2);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .themes-expanded-content .suggestion-card:hover:before {
        opacity: 1;
    }

    .card-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        background: linear-gradient(135deg, #00D4AA, #007AFF);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.1rem;
        flex-shrink: 0;
    }

    .card-content {
        flex: 1;
    }

    .themes-expanded-content .card-title {
        color: white;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.25rem;
    }

    .themes-expanded-content .card-subtitle {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }

    .card-performance {
        color: #00D4AA;
        font-size: 0.75rem;
        font-weight: 600;
    }

    /* Theme minimize/maximize styling */
    .theme-controls {
        display: flex;
        align-items: center;
    }

    .minimize-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .minimize-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        transform: scale(1.1);
    }

    .theme-details {
        transition: all 0.3s ease;
    }



    .theme-pill-more {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.6);
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .theme-pill-more:hover {
        background: rgba(255, 255, 255, 0.15);
        color: rgba(255, 255, 255, 0.8);
    }

    /* Market Insights Styling - Matching Investment Themes */
    .market-insights-condensed {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        border: 1px solid rgba(96, 165, 250, 0.15);
        margin-bottom: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .insights-indicator {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        cursor: pointer;
        background: rgba(96, 165, 250, 0.03);
        transition: all 0.3s ease;
    }

    .insights-indicator:hover {
        background: rgba(96, 165, 250, 0.06);
    }

    .insights-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .insights-label {
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .insights-right {
        margin-left: auto;
    }

    .insight-pills {
        display: flex;
        gap: 0.4rem;
    }

    .insight-pill {
        background: rgba(96, 165, 250, 0.2);
        color: white;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid rgba(96, 165, 250, 0.3);
    }

    .insight-pill:hover {
        background: rgba(96, 165, 250, 0.3);
        transform: translateY(-1px);
    }

    .insight-pill.live {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border-color: rgba(239, 68, 68, 0.3);
    }

    .insight-pill.trend {
        background: rgba(249, 115, 22, 0.2);
        color: #f97316;
        border-color: rgba(249, 115, 22, 0.3);
    }

    .insight-pill.risk {
        background: rgba(234, 179, 8, 0.2);
        color: #eab308;
        border-color: rgba(234, 179, 8, 0.3);
    }

    .insights-expanded-content {
        padding: 0 1rem 1rem 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        animation: slideDown 0.3s ease-out;
    }

    .insight-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 0.75rem;
        margin-top: 0.75rem;
        max-height: 350px;
        overflow-y: auto;
    }

    .insight-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .insight-card:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .insight-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        color: white;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .live-indicator {
        background: #ef4444;
        color: white;
        padding: 0.1rem 0.4rem;
        border-radius: 8px;
        font-size: 0.6rem;
        margin-left: auto;
    }

    .trend-indicator {
        background: #f97316;
        color: white;
        padding: 0.1rem 0.4rem;
        border-radius: 8px;
        font-size: 0.6rem;
        margin-left: auto;
    }

    .confidence-indicator {
        background: #00D4AA;
        color: white;
        padding: 0.1rem 0.4rem;
        border-radius: 8px;
        font-size: 0.6rem;
        margin-left: auto;
    }

    .risk-indicator {
        background: #eab308;
        color: white;
        padding: 0.1rem 0.4rem;
        border-radius: 8px;
        font-size: 0.6rem;
        margin-left: auto;
    }

    .market-stats {
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
    }

    .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
    }

    .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.7rem;
        margin-bottom: 0.2rem;
    }

    .stat-value {
        color: white;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .stat-value.positive {
        color: #00D4AA;
    }

    .stat-value.negative {
        color: #ef4444;
    }

    .stat-value.neutral {
        color: white;
    }

    .trending-list {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .trending-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.3rem 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .trending-item:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .symbol {
        color: white;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .trend-change {
        color: #00D4AA;
        font-weight: 600;
        font-size: 0.8rem;
    }

    .prediction-text {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.8rem;
        line-height: 1.4;
    }

    .risk-list {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
    }

    .risk-item {
        padding: 0.4rem;
        border-radius: 6px;
        border-left: 3px solid;
    }

    .risk-item.moderate {
        background: rgba(249, 115, 22, 0.1);
        border-color: #f97316;
    }

    .risk-item.low {
        background: rgba(234, 179, 8, 0.1);
        border-color: #eab308;
    }

    .risk-text {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.75rem;
    }

    /* Watchlist Modal Styling */
    .watchlist-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(10px);
        z-index: 10000;
        padding: 1rem;
    }

    .watchlist-modal-content {
        background: linear-gradient(135deg, #1a1a2e, #16213e);
        border-radius: 16px;
        border: 1px solid rgba(0, 212, 170, 0.3);
        max-width: 700px;
        width: 100%;
        max-height: 90vh;
        margin: 2rem auto;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .watchlist-modal-header {
        padding: 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(0, 212, 170, 0.1);
    }

    .watchlist-modal-header h3 {
        margin: 0;
        color: white;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .watchlist-close-btn {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .watchlist-close-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }

    .watchlist-modal-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }

    .watchlist-group {
        margin-bottom: 1.5rem;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        overflow: hidden;
    }

    .watchlist-header {
        padding: 1rem;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.03);
        transition: all 0.3s ease;
    }

    .watchlist-header:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .watchlist-name {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: white;
        font-weight: 600;
    }

    .watchlist-count {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
    }

    .watchlist-chevron {
        color: rgba(255, 255, 255, 0.6);
        transition: transform 0.3s ease;
    }

    .watchlist-chevron.rotated {
        transform: rotate(180deg);
    }

    .watchlist-content {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
    }

    .watchlist-content.expanded {
        max-height: 1000px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .watchlist-stock {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .watchlist-stock:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .watchlist-stock:last-child {
        border-bottom: none;
    }

    .stock-info {
        flex: 1;
    }

    .stock-symbol {
        color: white;
        font-weight: 600;
        font-size: 1rem;
    }

    .stock-name {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }

    .stock-data {
        text-align: right;
        margin-right: 1rem;
    }

    .stock-price {
        color: white;
        font-weight: 600;
    }

    .stock-change {
        font-size: 0.8rem;
        font-weight: 500;
    }
    
    /* Optimized compact watchlist stock layout */
    .watchlist-stock-compact {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }

    .watchlist-stock-compact:hover {
        background: rgba(96, 165, 250, 0.08);
        border: 1px solid rgba(96, 165, 250, 0.2);
        transform: translateY(-1px);
    }
    
    .stock-left {
        flex: 1;
        min-width: 0;
    }
    
    .stock-symbol-large {
        color: white;
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 0.2rem;
    }
    
    .stock-name-small {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.75rem;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .stock-center {
        flex: 0 0 auto;
        text-align: right;
        margin: 0 0.75rem;
    }
    
    .stock-price-main {
        color: white;
        font-weight: 600;
        font-size: 0.95rem;
        margin-bottom: 0.2rem;
    }
    
    .stock-change-compact {
        font-size: 0.8rem;
        font-weight: 500;
        padding: 0.15rem 0.4rem;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.05);
    }
    
    .stock-change-compact.positive {
        color: #10b981;
        background: rgba(16, 185, 129, 0.1);
    }
    
    .stock-change-compact.negative {
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }
    
    .stock-right {
        flex: 0 0 auto;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 0.3rem;
    }
    
    .stock-rating-compact {
        font-size: 0.7rem;
        font-weight: 600;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stock-rating-compact.rating-strong-buy {
        color: #059669;
        background: rgba(5, 150, 105, 0.15);
    }
    
    .stock-rating-compact.rating-buy {
        color: #10b981;
        background: rgba(16, 185, 129, 0.15);
    }
    
    .stock-rating-compact.rating-hold {
        color: #f59e0b;
        background: rgba(245, 158, 11, 0.15);
    }
    
    .stock-rating-compact.rating-sell {
        color: #f97316;
        background: rgba(249, 115, 22, 0.15);
    }
    
    .stock-rating-compact.rating-strong-sell {
        color: #dc2626;
        background: rgba(220, 38, 38, 0.15);
    }
    
    .remove-btn-compact {
        background: rgba(239, 68, 68, 0.1);
        border: none;
        color: #ef4444;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        transition: all 0.2s ease;
    }
    
    .remove-btn-compact:hover {
        background: rgba(239, 68, 68, 0.2);
        transform: scale(1.1);
    }

    .stock-change.positive {
        color: #00D4AA;
    }

    .stock-change.negative {
        color: #ef4444;
    }

    .stock-rating {
        padding: 0.25rem 0.5rem;
        border-radius: 6px;
        font-size: 0.7rem;
        font-weight: 600;
        margin-right: 1rem;
    }

    .stock-rating.rating-strong-buy {
        background: #00D4AA;
        color: black;
    }

    .stock-rating.rating-buy {
        background: #60a5fa;
        color: white;
    }

    .stock-rating.rating-hold {
        background: #fbbf24;
        color: black;
    }

    .stock-rating.rating-sell {
        background: #f87171;
        color: white;
    }

    .stock-rating.rating-strong-sell {
        background: #dc2626;
        color: white;
    }

    .stock-actions {
        display: flex;
        gap: 0.5rem;
    }

    .stock-action-btn {
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 6px;
        padding: 0.5rem;
        color: rgba(255, 255, 255, 0.7);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .stock-action-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    .remove-btn:hover {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
    }

    .watchlist-actions {
        margin-top: 1.5rem;
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
    }

    .watchlist-btn {
        flex: 1;
        min-width: 200px;
        padding: 0.75rem 1rem;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .watchlist-btn.primary {
        background: linear-gradient(135deg, #00D4AA, #007AFF);
        color: white;
    }

    .watchlist-btn.primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 20px rgba(0, 212, 170, 0.3);
    }

    .watchlist-btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .watchlist-btn.secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        transform: translateY(-1px);
    }

    /* Mobile optimization for insights - matching themes */
    @media (max-width: 768px) {
        .insights-indicator {
            padding: 0.6rem 0.8rem;
        }
        
        .insights-left {
            gap: 0.5rem;
        }
        
        .watchlist-modal {
            padding: 0.5rem;
        }
        
        .watchlist-modal-content {
            margin: 1rem auto;
            max-height: 95vh;
        }
        
        .watchlist-stock {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }
        
        .stock-data {
            text-align: left;
            margin-right: 0;
        }
        
        .watchlist-actions {
            flex-direction: column;
        }
        
        .watchlist-btn {
            min-width: auto;
        }
        
        .insights-label {
            font-size: 0.85rem;
        }
        
        .insight-pills {
            gap: 0.4rem;
            margin-left: 0.3rem;
        }
        
        .insight-pill {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
        }

        .insights-expanded-content .insight-cards {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .insight-pills {
            display: none;
        }
        
        .insights-label::after {
            content: " (Live data)";
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }
    }

    /* Dropdown Container - Unified alignment for all dropdowns */
    .dropdown-container {
        width: 100%;
        max-width: 100%;
        margin-left: 0;
        margin-right: 0;
        position: relative;
        box-sizing: border-box;
    }

    /* Ensure all dropdown containers have identical styling */
    .popular-stocks-condensed,
    .investment-themes-condensed,
    .market-insights-condensed {
        background: rgba(255, 255, 255, 0.02) !important;
        border-radius: 12px !important;
        border: 1px solid rgba(96, 165, 250, 0.15) !important;
        margin-bottom: 1rem !important;
        overflow: hidden !important;
        transition: all 0.3s ease !important;
        position: relative !important;
        display: block !important;
    }

    /* Ensure all indicator bars have identical styling */
    .popular-indicator,
    .themes-indicator,
    .insights-indicator {
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 0.75rem 1rem !important;
        cursor: pointer !important;
        background: rgba(96, 165, 250, 0.03) !important;
        transition: all 0.3s ease !important;
        margin: 0 !important;
        box-sizing: border-box !important;
    }

    .popular-indicator:hover,
    .themes-indicator:hover,
    .insights-indicator:hover {
        background: rgba(96, 165, 250, 0.06) !important;
    }

    /* Popular Stocks Dropdown - Perfectly matching other sections */
    .popular-stocks-condensed {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        border: 1px solid rgba(96, 165, 250, 0.15);
        margin-bottom: 1rem;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    /* Mobile responsiveness for Popular Stocks */
    @media (max-width: 768px) {
        .popular-pills {
            display: none;
        }
        
        .popular-label::after {
            content: " (6 stocks)";
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }

        .popular-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .popular-grid {
            grid-template-columns: 1fr;
        }
    }

    .popular-indicator {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        cursor: pointer;
        background: rgba(96, 165, 250, 0.03);
        transition: all 0.3s ease;
    }

    .popular-indicator:hover {
        background: rgba(96, 165, 250, 0.06);
    }

    .popular-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .popular-label {
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .popular-pills {
        display: flex;
        gap: 0.5rem;
        margin-left: 0.5rem;
    }

    .popular-pill {
        background: rgba(96, 165, 250, 0.2);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
    }

    .popular-pill.trending {
        background: rgba(255, 165, 0, 0.2);
        color: #ffa500;
    }

    .popular-pill.growth {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
    }

    .popular-pill.tech {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
    }

    .popular-right {
        display: flex;
        align-items: center;
    }

    .popular-expanded-content {
        background: rgba(255, 255, 255, 0.01);
        padding: 1rem;
        border-top: 1px solid rgba(96, 165, 250, 0.1);
        animation: expandDown 0.3s ease-out;
    }

    .popular-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 0.75rem;
    }

    .popular-stock-card {
        background: rgba(96, 165, 250, 0.05);
        border: 1px solid rgba(96, 165, 250, 0.15);
        border-radius: 8px;
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        color: white;
    }

    .popular-stock-card:hover {
        background: rgba(96, 165, 250, 0.1);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(96, 165, 250, 0.2);
    }

    .stock-symbol {
        font-weight: 700;
        font-size: 0.9rem;
        color: #60a5fa;
        margin-bottom: 0.25rem;
    }

    .stock-name {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 0.25rem;
    }

    .stock-price {
        font-weight: 600;
        color: white;
        font-size: 0.85rem;
    }

    .popular-indicator {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        cursor: pointer;
        background: rgba(96, 165, 250, 0.03);
        transition: all 0.3s ease;
    }

    .popular-indicator:hover {
        background: rgba(96, 165, 250, 0.06);
    }

    .popular-left {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        flex: 1;
    }

    .popular-label {
        color: white;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
    }

    .popular-pills {
        display: flex;
        gap: 0.4rem;
    }

    .popular-pill {
        background: rgba(96, 165, 250, 0.2);
        color: white;
        padding: 0.25rem 0.6rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid rgba(96, 165, 250, 0.3);
    }

    .popular-pill:hover {
        background: rgba(96, 165, 250, 0.3);
        transform: translateY(-1px);
    }

    .popular-pill.trending {
        background: rgba(249, 115, 22, 0.2);
        color: #f97316;
        border-color: rgba(249, 115, 22, 0.3);
    }

    .popular-pill.growth {
        background: rgba(34, 197, 94, 0.2);
        color: #22c55e;
        border-color: rgba(34, 197, 94, 0.3);
    }

    .popular-pill.tech {
        background: rgba(168, 85, 247, 0.2);
        color: #a855f7;
        border-color: rgba(168, 85, 247, 0.3);
    }

    .popular-right {
        margin-left: auto;
    }

    .popular-expanded-content {
        padding: 0 1rem 1rem 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        animation: slideDown 0.3s ease-out;
    }

    .popular-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        margin-top: 0.75rem;
    }

    .popular-stock-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 10px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        color: white;
    }

    .popular-stock-card:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .popular-stock-card .stock-symbol {
        font-weight: 700;
        font-size: 1rem;
        color: #60a5fa;
        margin-bottom: 0.25rem;
    }

    .popular-stock-card .stock-name {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        margin-bottom: 0.5rem;
    }

    .popular-stock-card .stock-price {
        font-weight: 600;
        font-size: 0.9rem;
        color: #22c55e;
    }

    /* Mobile optimization for popular stocks */
    @media (max-width: 768px) {
        .popular-indicator {
            padding: 0.6rem 0.8rem;
        }
        
        .popular-left {
            gap: 0.5rem;
        }
        
        .popular-label {
            font-size: 0.85rem;
        }
        
        .popular-pills {
            gap: 0.4rem;
            margin-left: 0.3rem;
        }
        
        .popular-pill {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
        }

        .popular-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .popular-stock-card {
            padding: 0.75rem;
        }
    }

    @media (max-width: 480px) {
        .popular-pills {
            display: none;
        }
        
        .popular-label::after {
            content: " (6 stocks)";
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }
        
        .popular-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Mobile optimization for themes */
    @media (max-width: 768px) {
        .themes-indicator {
            padding: 0.6rem 0.8rem;
        }
        
        .themes-left {
            gap: 0.5rem;
        }
        
        .themes-label {
            font-size: 0.85rem;
        }
        
        .theme-pills {
            gap: 0.4rem;
            margin-left: 0.3rem;
        }
        
        .theme-pill {
            font-size: 0.7rem;
            padding: 0.2rem 0.5rem;
        }

        .themes-expanded-content .suggestion-cards {
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }
    }

    @media (max-width: 480px) {
        .theme-pills {
            display: none;
        }
        
        .themes-label::after {
            content: " (12 themes)";
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.8rem;
        }
    }

    /* Portfolio Section & AI Builder Styles */
    .portfolio-section {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .portfolio-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .portfolio-header h3 {
        margin: 0;
        color: white;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .close-portfolio {
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0.25rem;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .close-portfolio:hover {
        background: rgba(255, 255, 255, 0.1);
        color: white;
    }

    .portfolio-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .stat-item {
        text-align: center;
        background: rgba(255, 255, 255, 0.05);
        padding: 0.75rem 0.5rem;
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stat-label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.75rem;
        margin-bottom: 0.25rem;
        font-weight: 500;
    }

    .stat-value {
        color: white;
        font-size: 0.95rem;
        font-weight: 600;
    }

    .profit-loss.positive {
        color: #10b981;
    }

    .profit-loss.negative {
        color: #ef4444;
    }
    
    /* Enhanced stock result styling */
    .close-search-btn:hover {
        background: rgba(255,255,255,0.2) !important;
        transform: scale(1.1);
    }
    
    .stock-header {
        padding: 20px;
    }
    
    .stock-symbol {
        font-size: 1.5rem;
        font-weight: bold;
        color: #60a5fa;
    }
    
    .stock-price {
        color: white;
        font-weight: 600;
    }
    
    /* Business summary expand/collapse styling */
    .business-summary-text {
        transition: max-height 0.3s ease, overflow 0.3s ease;
    }
    
    .expand-business-btn:hover {
        color: #93c5fd !important;
        background: rgba(96, 165, 250, 0.1) !important;
        border-radius: 4px;
        padding-left: 0.5rem !important;
        padding-right: 0.5rem !important;
    }
    
    .expand-business-btn:hover .expand-icon {
        color: #93c5fd;
    }

    .portfolio-holdings {
        max-height: 400px;
        overflow-y: auto;
    }

    .loading-portfolio {
        text-align: center;
        color: rgba(255, 255, 255, 0.7);
        padding: 2rem;
        font-style: italic;
    }

    .holding-item {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 0.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }

    .holding-item:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-1px);
    }

    .holding-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }

    .holding-symbol {
        font-weight: 600;
        font-size: 1rem;
        color: white;
    }

    .holding-value {
        font-weight: 600;
        color: #00D4AA;
        font-size: 0.9rem;
    }

    .holding-details {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
        font-size: 0.75rem;
        margin-bottom: 0.5rem;
    }

    .detail-small {
        color: rgba(255, 255, 255, 0.7);
        text-align: center;
    }

    .detail-small div:first-child {
        margin-bottom: 2px;
        font-size: 0.7rem;
    }

    .detail-small div:last-child {
        font-size: 0.8rem;
    }

    .holding-actions {
        display: flex;
        gap: 0.5rem;
    }

    .holding-btn {
        padding: 0.3rem 0.6rem;
        border: none;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        flex: 1;
    }

    .buy-btn {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .buy-btn:hover {
        background: rgba(16, 185, 129, 0.3);
    }

    .sell-btn {
        background: rgba(239, 68, 68, 0.2);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .sell-btn:hover {
        background: rgba(239, 68, 68, 0.3);
    }

    .main-content {
        flex: 1;
        padding: 2rem 1.5rem;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        max-width: 900px;
        margin: 0 auto;
        overflow-y: auto;
    }

    /* Suggestion Cards */
    .suggestion-cards {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        width: 100%;
        max-width: 400px;
        margin-bottom: 2rem;
    }

    /* Horizontal Layout for Compact Display */
    .suggestion-cards.horizontal-layout {
        flex-direction: row !important;
        flex-wrap: wrap;
        max-width: 100%;
        gap: 0.5rem;
        margin-bottom: 1rem;
        justify-content: center;
    }

    .suggestion-card.compact {
        flex: 1 1 auto;
        min-width: 110px;
        max-width: 150px;
        padding: 0.6rem;
        text-align: center;
    }

    .suggestion-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    /* Compact card overrides - must come after base styles */
    .suggestion-card.compact {
        padding: 0.6rem !important;
        text-align: center !important;
        flex: 1 1 auto !important;
        min-width: 110px !important;
        max-width: 150px !important;
    }

    .suggestion-card.compact .card-title {
        font-size: 0.8rem !important;
        font-weight: 600 !important;
        margin-bottom: 0.2rem !important;
        line-height: 1.2 !important;
    }

    .suggestion-card.compact .card-subtitle {
        font-size: 0.7rem !important;
        color: rgba(255, 255, 255, 0.5) !important;
        line-height: 1.2 !important;
    }

    .suggestion-card:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
    }

    .card-title {
        font-size: 0.9rem;
        font-weight: 500;
        margin-bottom: 0.25rem;
    }

    .card-subtitle {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
    }

    /* Search Results */
    .search-results {
        width: 100%;
        max-width: 500px;
        margin-top: 1rem;
    }

    .stock-result {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }

    .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .stock-symbol {
        font-size: 1.25rem;
        font-weight: 600;
    }

    .stock-price {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--green);
    }

    .stock-change {
        font-size: 0.9rem;
        margin-top: 0.25rem;
    }

    .change-positive { color: var(--green); }
    .change-negative { color: var(--red); }

    .ai-analysis {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ai-recommendation {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        margin-bottom: 0.5rem;
    }

    .ai-recommendation.buy { 
        background: #10b981 !important; 
        color: white !important; 
    }
    .ai-recommendation.strong-buy { 
        background: #059669 !important; 
        color: white !important; 
    }
    .ai-recommendation.sell { 
        background: #ef4444 !important; 
        color: white !important; 
    }
    .ai-recommendation.strong-sell { 
        background: #dc2626 !important; 
        color: white !important; 
    }
    .ai-recommendation.hold { 
        background: #fbbf24 !important; 
        color: #000000 !important; 
        font-weight: 600;
    }
    
    .force-dark-text,
    .force-dark-text *,
    .ai-recommendation.hold,
    .ai-recommendation.hold *,
    .ai-recommendation.hold .recommendation-text {
        color: #000000 !important;
        text-shadow: none !important;
    }
    
    .force-white-text,
    .force-white-text *,
    .ai-recommendation.buy,
    .ai-recommendation.buy *,
    .ai-recommendation.strong-buy,
    .ai-recommendation.strong-buy *,
    .ai-recommendation.sell,
    .ai-recommendation.sell *,
    .ai-recommendation.strong-sell,
    .ai-recommendation.strong-sell * {
        color: white !important;
    }

    /* Purchase Actions */
    .purchase-actions {
        display: flex;
        gap: 0.75rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }

    .purchase-btn {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.25rem;
        border: none;
        border-radius: 25px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        text-decoration: none;
        min-height: 44px;
    }

    .purchase-btn.primary {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .purchase-btn.primary:hover {
        background: linear-gradient(135deg, #059669, #047857);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        transform: translateY(-2px);
    }

    .purchase-btn.secondary {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .purchase-btn.secondary:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    @media (max-width: 768px) {
        .purchase-actions {
            flex-direction: column;
        }
        
        .purchase-btn {
            justify-content: center;
            min-height: 48px;
        }
    }

    /* Bottom Input Area */
    .input-area {
        padding: 1.5rem;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    .input-container {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 25px;
        display: flex;
        align-items: center;
        padding: 0.5rem 1rem;
        margin-bottom: 0.75rem;
    }

    .search-input {
        flex: 1;
        background: transparent;
        border: none;
        outline: none;
        color: white;
        font-size: 1rem;
        padding: 0.5rem 0;
    }

    .search-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    .submit-btn {
        background: var(--green);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .submit-btn:hover {
        background: var(--green-hover);
        transform: scale(1.05);
    }

    /* Quick Stock Buttons */
    .quick-stocks {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: center;
    }

    .quick-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 20px;
        color: white;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .quick-btn:hover {
        background: rgba(255, 255, 255, 0.15);
        border-color: rgba(255, 255, 255, 0.3);
    }

    /* Loading State */
    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2rem;
    }

    .loading-spinner {
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 2px solid var(--green);
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Search Suggestions */
    .search-suggestions {
        width: 100%;
        max-width: 500px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-top: 1rem;
        display: none;
        overflow: hidden;
    }

    .suggestion-item {
        padding: 0.75rem 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        cursor: pointer;
        transition: background-color 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .suggestion-item:hover {
        background: rgba(255, 255, 255, 0.08);
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-company {
        font-weight: 500;
    }

    .suggestion-symbol {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.9rem;
    }

    /* Responsive Design */
    @media (max-width: 480px) {
        .main-content {
            padding: 1rem;
        }
        
        /* Additional mobile spacing improvements */
        .portfolio-stats {
            gap: 0.75rem !important;
        }
        
        .suggestion-cards {
            gap: 0.5rem !important;
        }
        
        .input-container {
            margin: 0 auto;
        }
        
        /* Mobile modal optimizations */
        .modal-content {
            width: 95% !important;
            margin: 2rem auto !important;
        }
        
        .modal-header {
            padding: 1rem 2.5rem 1rem 1rem !important;
        }
        
        .modal-close {
            right: 0.5rem !important;
            top: 0.5rem !important;
            width: 28px !important;
            height: 28px !important;
            font-size: 1.4rem !important;
        }
        
        .suggestion-cards {
            max-width: 100%;
            flex-direction: column !important;
        }

        .suggestion-cards .suggestion-card {
            max-width: 100% !important;
            flex: none !important;
            text-align: left !important;
        }
    }

    @media (min-width: 481px) and (max-width: 768px) {
        .suggestion-card.compact {
            min-width: 140px;
            max-width: 180px;
        }
    }

    /* Subscription Status Styling */
    .subscription-status-fixed {
        position: fixed;
        bottom: 6.5rem;
        right: 1rem;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.15);
        border-radius: 8px;
        padding: 0.5rem 0.75rem;
        z-index: 500;
        backdrop-filter: blur(10px);
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.7);
        font-weight: 500;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        pointer-events: none;
        user-select: none;
    }

    .subscription-status-fixed:hover {
        background: rgba(255, 255, 255, 0.12);
        border-color: rgba(255, 255, 255, 0.25);
        color: rgba(255, 255, 255, 0.9);
    }

    .subscription-status {
        display: none; /* Hide the inline version, keep only fixed */
    }

    /* Mobile optimization for subscription status */
    @media (max-width: 768px) {
        .subscription-status-fixed {
            bottom: 6rem;
            right: 0.75rem;
            font-size: 0.7rem;
            padding: 0.4rem 0.6rem;
        }
    }

    @media (max-width: 480px) {
        .subscription-status-fixed {
            bottom: 5.5rem;
            right: 0.5rem;
            font-size: 0.65rem;
            padding: 0.35rem 0.5rem;
        }
    }
    </style>

    <script>
    // Define toggle functions first (globally accessible)
    function togglePopularExpanded() {
        const expandedContent = document.getElementById('popular-expanded-content');
        const expandIcon = document.getElementById('popular-expand-icon');
        
        if (!expandedContent || !expandIcon) return;
        
        const isExpanded = expandedContent.style.display === 'block';
        
        if (isExpanded) {
            expandedContent.style.display = 'none';
            expandIcon.classList.remove('expanded');
        } else {
            expandedContent.style.display = 'block';
            expandIcon.classList.add('expanded');
        }
    }
    
    function toggleThemesExpanded() {
        const expandedContent = document.getElementById('themes-expanded-content');
        const expandIcon = document.getElementById('themes-expand-icon');
        
        if (!expandedContent || !expandIcon) return;
        
        const isExpanded = expandedContent.style.display === 'block';
        
        if (isExpanded) {
            expandedContent.style.display = 'none';
            expandIcon.classList.remove('expanded');
        } else {
            expandedContent.style.display = 'block';
            expandIcon.classList.add('expanded');
        }
    }
    
    function toggleInsightsExpanded() {
        const expandedContent = document.getElementById('insights-expanded-content');
        const expandIcon = document.getElementById('insights-expand-icon');
        
        if (!expandedContent || !expandIcon) return;
        
        const isExpanded = expandedContent.style.display === 'block';
        
        if (isExpanded) {
            expandedContent.style.display = 'none';
            expandIcon.classList.remove('expanded');
        } else {
            expandedContent.style.display = 'block';
            expandIcon.classList.add('expanded');
        }
    }

    // Comprehensive intelligent company name to symbol mapping
    const companyMap = {
        // Tech Giants
        'apple': 'AAPL', 'apple inc': 'AAPL', 'apple computer': 'AAPL',
        'microsoft': 'MSFT', 'microsoft corp': 'MSFT', 'microsoft corporation': 'MSFT', 'msft': 'MSFT',
        'google': 'GOOGL', 'alphabet': 'GOOGL', 'alphabet inc': 'GOOGL', 'googl': 'GOOGL',
        'amazon': 'AMZN', 'amazon.com': 'AMZN', 'amazon inc': 'AMZN', 'amzn': 'AMZN',
        'meta': 'META', 'facebook': 'META', 'meta platforms': 'META', 'meta platforms inc': 'META',
        'tesla': 'TSLA', 'tesla inc': 'TSLA', 'tesla motors': 'TSLA', 'tsla': 'TSLA',
        'nvidia': 'NVDA', 'nvidia corp': 'NVDA', 'nvidia corporation': 'NVDA', 'nvda': 'NVDA',
        'netflix': 'NFLX', 'netflix inc': 'NFLX', 'nflx': 'NFLX',
        
        // Semiconductor & Hardware
        'intel': 'INTC', 'intel corp': 'INTC', 'intel corporation': 'INTC',
        'amd': 'AMD', 'advanced micro devices': 'AMD',
        'qualcomm': 'QCOM', 'qualcomm inc': 'QCOM',
        'broadcom': 'AVGO', 'broadcom inc': 'AVGO',
        'micron': 'MU', 'micron technology': 'MU',
        
        // Software & Cloud
        'salesforce': 'CRM', 'salesforce.com': 'CRM',
        'oracle': 'ORCL', 'oracle corp': 'ORCL', 'oracle corporation': 'ORCL',
        'adobe': 'ADBE', 'adobe inc': 'ADBE', 'adobe systems': 'ADBE',
        'servicenow': 'NOW', 'service now': 'NOW',
        'snowflake': 'SNOW', 'snowflake inc': 'SNOW',
        'palantir': 'PLTR', 'palantir technologies': 'PLTR',
        
        // Social & Communication
        'zoom': 'ZM', 'zoom video': 'ZM', 'zoom communications': 'ZM',
        'twitter': 'TWTR', 'x corp': 'TWTR',
        'snapchat': 'SNAP', 'snap inc': 'SNAP',
        'pinterest': 'PINS', 'pinterest inc': 'PINS',
        'discord': 'DISCORD',
        
        // E-commerce & Digital
        'shopify': 'SHOP', 'shopify inc': 'SHOP',
        'paypal': 'PYPL', 'paypal holdings': 'PYPL',
        'square': 'SQ', 'block inc': 'SQ', 'block': 'SQ',
        'ebay': 'EBAY', 'ebay inc': 'EBAY',
        'etsy': 'ETSY', 'etsy inc': 'ETSY',
        
        // Financial Services
        'visa': 'V', 'visa inc': 'V',
        'mastercard': 'MA', 'mastercard inc': 'MA',
        'jpmorgan': 'JPM', 'jp morgan': 'JPM', 'jpmorgan chase': 'JPM',
        'bank of america': 'BAC', 'bofa': 'BAC',
        'wells fargo': 'WFC', 'wells fargo & company': 'WFC',
        'goldman sachs': 'GS', 'goldman': 'GS',
        'morgan stanley': 'MS',
        'american express': 'AXP', 'amex': 'AXP',
        'berkshire hathaway': 'BRK-B', 'berkshire': 'BRK-B',
        
        // Cryptocurrency
        'coinbase': 'COIN', 'coinbase global': 'COIN',
        'microstrategy': 'MSTR', 'micro strategy': 'MSTR',
        
        // Transportation & Mobility
        'uber': 'UBER', 'uber technologies': 'UBER',
        'lyft': 'LYFT', 'lyft inc': 'LYFT',
        'tesla': 'TSLA', 'ford': 'F', 'ford motor': 'F', 'ford motor company': 'F',
        'general motors': 'GM', 'gm': 'GM',
        'boeing': 'BA', 'boeing company': 'BA',
        'airbnb': 'ABNB', 'airbnb inc': 'ABNB',
        
        // Entertainment & Media
        'disney': 'DIS', 'walt disney': 'DIS', 'walt disney company': 'DIS',
        'netflix': 'NFLX', 'comcast': 'CMCSA', 'comcast corp': 'CMCSA',
        'warner bros': 'WBD', 'warner bros discovery': 'WBD',
        'spotify': 'SPOT', 'spotify technology': 'SPOT',
        'roku': 'ROKU', 'roku inc': 'ROKU',
        'roblox': 'RBLX', 'roblox corp': 'RBLX',
        'unity': 'U', 'unity software': 'U',
        
        // Consumer & Retail
        'walmart': 'WMT', 'walmart inc': 'WMT',
        'target': 'TGT', 'target corp': 'TGT',
        'costco': 'COST', 'costco wholesale': 'COST',
        'home depot': 'HD', 'the home depot': 'HD',
        'lowes': 'LOW', "lowe's": 'LOW', 'lowes companies': 'LOW',
        'starbucks': 'SBUX', 'starbucks corp': 'SBUX',
        'mcdonalds': 'MCD', "mcdonald's": 'MCD', 'mcdonalds corp': 'MCD',
        'nike': 'NKE', 'nike inc': 'NKE',
        'coca cola': 'KO', 'coca-cola': 'KO', 'coke': 'KO',
        'pepsi': 'PEP', 'pepsico': 'PEP', 'pepsi co': 'PEP',
        
        // Healthcare & Biotech
        'johnson & johnson': 'JNJ', 'johnson and johnson': 'JNJ', 'jnj': 'JNJ',
        'pfizer': 'PFE', 'pfizer inc': 'PFE',
        'moderna': 'MRNA', 'moderna inc': 'MRNA',
        'abbvie': 'ABBV', 'abbvie inc': 'ABBV',
        'merck': 'MRK', 'merck & co': 'MRK',
        'bristol myers': 'BMY', 'bristol myers squibb': 'BMY',
        
        // Energy
        'exxon': 'XOM', 'exxon mobil': 'XOM', 'exxonmobil': 'XOM',
        'chevron': 'CVX', 'chevron corp': 'CVX',
        'conocophillips': 'COP', 'conoco phillips': 'COP',
        
        // Telecommunications
        'verizon': 'VZ', 'verizon communications': 'VZ',
        'at&t': 'T', 'att': 'T', 'at and t': 'T',
        't-mobile': 'TMUS', 'tmobile': 'TMUS', 't mobile': 'TMUS',
        
        // Real Estate & Fitness
        'peloton': 'PTON', 'peloton interactive': 'PTON',
        'zillow': 'Z', 'zillow group': 'Z',
        
        // Food & Delivery
        'doordash': 'DASH', 'door dash': 'DASH',
        'uber eats': 'UBER', 'grubhub': 'GRUB',
        'beyond meat': 'BYND', 'beyond meat inc': 'BYND'
    };

    // Advanced ChatGPT-style intelligent search with multiple matching strategies
    function intelligentSearch(query) {
        const normalizedQuery = query.toLowerCase().trim();
        
        console.log('TradeWise AI: Intelligent search processing:', normalizedQuery);
        
        // Direct symbol match (already ticker symbols like AAPL, TSLA)
        // Only match if the original query is already in uppercase or mixed case ticker format
        if (/^[A-Z]{1,5}(-[A-Z])?$/.test(query) && query === query.toUpperCase()) {
            console.log('TradeWise AI: Direct symbol match:', query.toUpperCase());
            return query.toUpperCase();
        }
        
        // Strategy 1: Exact company name match
        if (companyMap[normalizedQuery]) {
            console.log('TradeWise AI: Exact match found:', companyMap[normalizedQuery]);
            return companyMap[normalizedQuery];
        }
        
        // Strategy 2: Handle common variations and partial matches
        const cleanQuery = normalizedQuery.replace(/[.,\-\s]+/g, ' ').trim();
        if (companyMap[cleanQuery]) {
            console.log('TradeWise AI: Clean query match found:', companyMap[cleanQuery]);
            return companyMap[cleanQuery];
        }
        
        // Strategy 3: First word exact match (e.g., "apple" in "apple computer")
        const firstWord = normalizedQuery.split(' ')[0];
        if (firstWord.length >= 3) {
            for (const [company, symbol] of Object.entries(companyMap)) {
                if (company === firstWord) {
                    console.log('TradeWise AI: First word match found:', symbol);
                    return symbol;
                }
            }
        }
        
        // Strategy 4: Fuzzy matching - company contains query or query contains company
        for (const [company, symbol] of Object.entries(companyMap)) {
            if (company.includes(normalizedQuery) || normalizedQuery.includes(company)) {
                return symbol;
            }
        }
        
        // Strategy 5: Starts with matching for partial typing
        for (const [company, symbol] of Object.entries(companyMap)) {
            if (company.startsWith(normalizedQuery) || normalizedQuery.startsWith(company)) {
                return symbol;
            }
        }
        
        // Strategy 6: Advanced fuzzy matching for multi-word queries
        const queryWords = normalizedQuery.split(' ').filter(function(word) { return word.length > 2; });
        for (const [company, symbol] of Object.entries(companyMap)) {
            const companyWords = company.split(' ');
            const matchCount = queryWords.filter(function(qWord) {
                return companyWords.some(function(cWord) { return cWord.includes(qWord) || qWord.includes(cWord); });
            }).length;
            
            // If majority of words match, return the symbol
            if (matchCount > 0 && matchCount >= Math.min(queryWords.length, companyWords.length) * 0.5) {
                return symbol;
            }
        }
        
        // Strategy 7: Special handling for common abbreviations and nicknames
        const abbreviations = {
            'fb': 'META', 'ig': 'META', 'instagram': 'META', 'whatsapp': 'META',
            'amzn': 'AMZN', 'aws': 'AMZN', 'amazon web services': 'AMZN',
            'goog': 'GOOGL', 'youtube': 'GOOGL', 'gmail': 'GOOGL',
            'msft': 'MSFT', 'windows': 'MSFT', 'xbox': 'MSFT', 'office': 'MSFT',
            'aapl': 'AAPL', 'iphone': 'AAPL', 'ipad': 'AAPL', 'mac': 'AAPL', 'macbook': 'AAPL',
            'tsla': 'TSLA', 'spacex': 'TSLA', 'elon musk': 'TSLA',
            'nvda': 'NVDA', 'geforce': 'NVDA', 'rtx': 'NVDA'
        };
        
        if (abbreviations[normalizedQuery]) {
            console.log('TradeWise AI: Abbreviation match found:', abbreviations[normalizedQuery]);
            return abbreviations[normalizedQuery];
        }
        
        console.log('TradeWise AI: No intelligent match found, returning uppercase:', query.toUpperCase());
        // If no intelligent match found, return as uppercase (might be a valid symbol)
        return query.toUpperCase();
    }

    // Enhanced search functionality
    function searchStock(symbol) {
        console.log('TradeWise AI: Searching for', symbol);
        showLoading();
        
        fetch('/api/stock-analysis/' + symbol)
            .then(response => response.json())
            .then(data => {
                console.log('TradeWise AI: API Response', data);
                if (data.ai_recommendation) {
                    console.log('TradeWise AI: Recommendation is:', data.ai_recommendation, 'Lowercase:', data.ai_recommendation.toLowerCase());
                }
                hideLoading();
                displayResult(data);
                
                // Force styling for all recommendations
                setTimeout(() => {
                    const recommendations = document.querySelectorAll('.ai-recommendation');
                    recommendations.forEach(el => {
                        const rec = el.textContent.split(' (')[0].toLowerCase();
                        // Get recommendation styles inline
                        let styles = '';
                        switch(rec) {
                            case 'strong buy':
                                styles = 'color: white !important; background: #059669 !important;';
                                break;
                            case 'buy':
                                styles = 'color: white !important; background: #10b981 !important;';
                                break;
                            case 'hold':
                                styles = 'color: #000000 !important; background: #fbbf24 !important;';
                                break;
                            case 'sell':
                                styles = 'color: white !important; background: #ef4444 !important;';
                                break;
                            case 'strong sell':
                                styles = 'color: white !important; background: #dc2626 !important;';
                                break;
                            default:
                                styles = 'color: white !important; background: #6b7280 !important;';
                        }
                        
                        // Apply background and text colors based on recommendation
                        if (rec === 'hold') {
                            el.style.setProperty('color', '#000000', 'important');
                            el.style.setProperty('background', '#fbbf24', 'important');
                            const spans = el.querySelectorAll('span');
                            spans.forEach(span => {
                                if (!span.style.color || span.style.color !== 'rgba(0,0,0,0.7)') {
                                    span.style.setProperty('color', '#000000', 'important');
                                }
                            });
                        } else {
                            el.style.setProperty('color', 'white', 'important');
                            // Set specific background colors for each recommendation type
                            if (rec === 'strong buy') el.style.setProperty('background', '#059669', 'important');
                            else if (rec === 'buy') el.style.setProperty('background', '#10b981', 'important');
                            else if (rec === 'sell') el.style.setProperty('background', '#ef4444', 'important');
                            else if (rec === 'strong sell') el.style.setProperty('background', '#dc2626', 'important');
                        }
                    });
                }, 100);
            })
            .catch(error => {
                console.error('TradeWise AI: Search Error:', error.message || error);
                hideLoading();
                showError('Unable to find stock "' + symbol + '". Please verify the symbol is correct or try searching for the company name.');
            });
    }

    function performSearch() {
        const input = document.getElementById('stock-search-input');
        const query = input.value.trim();
        
        if (!query) return;
        
        // Use intelligent search to convert query to symbol
        const symbol = intelligentSearch(query);
        console.log('TradeWise AI: Converting "' + query + '"  "' + symbol + '"');
        
        searchStock(symbol);
        input.value = '';
    }

    function handleEnterPress(event) {
        if (event.key === 'Enter') {
            performSearch();
        }
    }

    function showLoading() {
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML = 
            '<div class="loading">' +
                '<div class="loading-spinner"></div>' +
                '<span>Analyzing stock...</span>' +
            '</div>';
        
        // Hide suggestion cards
        document.querySelector('.suggestion-cards').style.display = 'none';
    }
    
    function showLoadingState(message = 'Loading...') {
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML = 
            '<div class="loading">' +
                '<div class="loading-spinner"></div>' +
                '<span>' + message + '</span>' +
            '</div>';
    }

    function hideLoadingState() {
        // Clear loading state - this function was missing!
        const resultsDiv = document.getElementById('search-results');
        if (resultsDiv) {
            // Check if there's a loading element and clear it
            const loadingElement = resultsDiv.querySelector('.loading');
            if (loadingElement) {
                resultsDiv.innerHTML = '';
            }
        }
    }

    function hideLoading() {
        // Show suggestion cards if no results
        const resultsDiv = document.getElementById('search-results');
        if (!resultsDiv.innerHTML || resultsDiv.innerHTML.includes('loading')) {
            document.querySelector('.suggestion-cards').style.display = 'flex';
        }
    }
    
    function closeSearchResults() {
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML = '';
        
        // Show suggestion cards again
        document.querySelector('.suggestion-cards').style.display = 'flex';
        
        // Clear search input
        const input = document.getElementById('stock-search-input');
        if (input) {
            input.value = '';
            input.focus();
        }
    }
    
    function toggleBusinessSummary(symbol) {
        const container = document.getElementById('business-summary-' + symbol);
        const textElement = container.querySelector('.business-summary-text');
        const button = container.querySelector('.expand-business-btn');
        const expandText = button.querySelector('.expand-text');
        const expandIcon = button.querySelector('.expand-icon');
        
        const isExpanded = textElement.style.maxHeight === 'none';
        
        if (isExpanded) {
            // Collapse
            textElement.style.maxHeight = '4.2em';
            textElement.style.overflow = 'hidden';
            expandText.textContent = 'Show more';
            expandIcon.style.transform = 'rotate(0deg)';
        } else {
            // Expand
            textElement.style.maxHeight = 'none';
            textElement.style.overflow = 'visible';
            expandText.textContent = 'Show less';
            expandIcon.style.transform = 'rotate(180deg)';
        }
    }

    function displayResult(data) {
        const resultsDiv = document.getElementById('search-results');
        
        if (!data.success || !data.ai_recommendation) {
            showError(data.error || 'Stock not found');
            return;
        }

        const changeClass = data.change >= 0 ? 'change-positive' : 'change-negative';
        const changeSymbol = data.change >= 0 ? '+' : '';
        
        // Format metrics helper
        const formatMetric = (value, suffix = '') => {
            if (value === null || value === undefined || value === 'N/A') return 'N/A';
            if (typeof value === 'number') {
                if (suffix === '%') return (value * 100).toFixed(2) + '%';
                return value.toFixed(2);
            }
            return value;
        };
        
        // Format price with proper decimal places
        const formatPrice = (price) => {
            if (typeof price === 'number') {
                return price.toFixed(2);
            }
            return parseFloat(price).toFixed(2);
        };
        
        // Get recommendation styles based on type
        const getRecommendationStyles = (recommendation) => {
            const rec = recommendation.toLowerCase();
            switch(rec) {
                case 'strong buy':
                    return 'color: white !important; background: #059669 !important;';
                case 'buy':
                    return 'color: white !important; background: #10b981 !important;';
                case 'hold':
                    return 'color: #000000 !important; background: #fbbf24 !important;';
                case 'sell':
                    return 'color: white !important; background: #ef4444 !important;';
                case 'strong sell':
                    return 'color: white !important; background: #dc2626 !important;';
                default:
                    return 'color: white !important; background: #6b7280 !important;';
            }
        };
        
        const stockResultHTML = 
            '<div class="stock-result">' +
                '<div class="stock-header" style="position: relative;">' +
                    '<button class="close-search-btn" onclick="closeSearchResults()" style="position: absolute; top: -10px; right: -10px; background: rgba(255,255,255,0.1); border: none; border-radius: 50%; width: 32px; height: 32px; color: rgba(255,255,255,0.8); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s;">' +
                        '' +
                    '</button>' +
                    '<div style="text-align: center; width: 100%;">' +
                        '<div class="stock-symbol" style="margin: 0 auto;">' + data.symbol + '</div>' +
                        '<div class="stock-name" style="color: rgba(255,255,255,0.7); font-size: 0.9rem; margin: 0 auto;">' +
                            data.name +
                            (data.sector && data.sector !== 'Unknown' ? '<span style="color: rgba(255,255,255,0.5);">  ' + data.sector + '</span>' : '') +
                        '</div>' +
                    '</div>' +
                    '<div style="text-align: center; margin-top: 15px;">' +
                        '<div class="stock-price" style="font-size: 2rem; font-weight: bold; margin: 0;">$' + formatPrice(data.price) + '</div>' +
                        '<div class="stock-change ' + changeClass + '" style="font-size: 1rem; margin: 5px 0 0 0;">' +
                            changeSymbol + '$' + Math.abs(data.change).toFixed(2) + ' (' + data.change_percent + '%)' +
                        '</div>' +
                    '</div>' +
                '</div>' +
                '<div class="ai-analysis">' +
                    '<div class="ai-recommendation ' + (data.ai_recommendation ? data.ai_recommendation.toLowerCase().replace(/\s+/g, '-') : 'unknown') + ' ' + (data.ai_recommendation && data.ai_recommendation.toLowerCase() === 'hold' ? 'force-dark-text' : 'force-white-text') + '">' +
                        '<span style="' + (data.ai_recommendation && data.ai_recommendation.toLowerCase() === 'hold' ? 'color: #000000 !important;' : 'color: white !important;') + '">' + (data.ai_recommendation || 'N/A') + '</span> (<span style="' + (data.ai_recommendation && data.ai_recommendation.toLowerCase() === 'hold' ? 'color: rgba(0,0,0,0.7);' : 'color: rgba(255,255,255,0.9);') + '">' + (data.ai_confidence || 0) + '% confidence</span>)' +
                    '</div>' +
                    '<p style="color: rgba(255,255,255,0.8); line-height: 1.4; margin: 0.5rem 0 1rem 0;">' +
                        data.analysis +
                    '</p>' +
                    '<div class="purchase-actions">' +
                        '<button class="purchase-btn primary" onclick="showPurchaseModal(\'' + data.symbol + '\', \'' + data.name + '\', ' + data.price + ', \'' + data.ai_recommendation + '\', ' + data.ai_confidence + ')">' +
                            '<i class="fas fa-shopping-cart"></i>' +
                            'Buy ' + data.symbol +
                        '</button>' +
                        '<button class="purchase-btn secondary" onclick="addStockToWatchlist(\'' + data.symbol + '\')">' +
                            '<i class="fas fa-star"></i>' +
                            'Add to Watchlist' +
                        '</button>' +
                    '</div>' +
                '</div>'
                
                + (Object.keys(data.key_metrics || {}).length > 0 || data.market_cap || data.pe_ratio ? 
                '<div class="comprehensive-metrics">' +
                    '<div class="metrics-grid">' +
                        (data.market_cap ? 
                        '<div class="metric-item">' +
                            '<span class="metric-label">Market Cap</span>' +
                            '<span class="metric-value">' + data.market_cap + '</span>' +
                        '</div>' : '') +
                        (data.pe_ratio ? 
                        '<div class="metric-item">' +
                            '<span class="metric-label">P/E Ratio</span>' +
                            '<span class="metric-value">' + formatMetric(data.pe_ratio) + '</span>' +
                        '</div>' : '') +
                        (data.beta ? 
                        '<div class="metric-item">' +
                            '<span class="metric-label">Beta</span>' +
                            '<span class="metric-value">' + formatMetric(data.beta) + '</span>' +
                        '</div>' : '') +
                        (data.volume ? 
                        '<div class="metric-item">' +
                            '<span class="metric-label">Volume</span>' +
                            '<span class="metric-value">' + data.volume + '</span>' +
                        '</div>' : '') +
                        (data.week_52_high ? 
                        '<div class="metric-item">' +
                            '<span class="metric-label">52W High</span>' +
                            '<span class="metric-value">$' + formatPrice(data.week_52_high) + '</span>' +
                        '</div>' : '') +
                        (data.week_52_low ? 
                        '<div class="metric-item">' +
                            '<span class="metric-label">52W Low</span>' +
                            '<span class="metric-value">$' + formatPrice(data.week_52_low) + '</span>' +
                        '</div>' : '') +
                        (data.dividend_yield ? 
                        '<div class="metric-item">' +
                            '<span class="metric-label">Dividend Yield</span>' +
                            '<span class="metric-value">' + formatMetric(data.dividend_yield, '%') + '</span>' +
                        '</div>' : '') +
                    '</div>' +
                '</div>' : '') +
                
                (data.investment_thesis && data.investment_thesis.length > 20 ? 
                '<div class="investment-section">' +
                    '<h4 style="margin: 1rem 0 0.5rem 0; color: rgba(255,255,255,0.9); font-size: 0.95rem;">Investment Thesis</h4>' +
                    '<p style="color: rgba(255,255,255,0.8); line-height: 1.4; margin: 0; font-size: 0.9rem;">' +
                        data.investment_thesis +
                    '</p>' +
                '</div>' : '') +
                
                (data.business_summary && data.business_summary.length > 50 ? 
                '<div class="business-section">' +
                    '<h4 style="margin: 1rem 0 0.5rem 0; color: rgba(255,255,255,0.9); font-size: 0.95rem;">About ' + data.name + '</h4>' +
                    '<div class="business-summary-container" id="business-summary-' + data.symbol + '">' +
                        '<p class="business-summary-text" style="color: rgba(255,255,255,0.7); line-height: 1.4; margin: 0; font-size: 0.85rem; max-height: 4.2em; overflow: hidden; position: relative;">' +
                            data.business_summary +
                        '</p>' +
                        '<button class="expand-business-btn" onclick="toggleBusinessSummary(\'' + data.symbol + '\')" style="background: none; border: none; color: #60a5fa; cursor: pointer; font-size: 0.8rem; padding: 0.25rem 0; margin-top: 0.25rem; display: flex; align-items: center; gap: 0.25rem;">' +
                            '<span class="expand-text">Show more</span>' +
                            '<i class="fas fa-chevron-down expand-icon" style="font-size: 0.7rem; transition: transform 0.3s ease;"></i>' +
                        '</button>' +
                    '</div>' +
                '</div>' : '') +
            '</div>';
        
        resultsDiv.innerHTML = stockResultHTML;
    }
    
    // Recently viewed stocks functionality
    function addToRecentlyViewed(symbol, name, price) {
        const recentStocks = JSON.parse(localStorage.getItem('recently_viewed_stocks') || '[]');
        
        // Remove if already exists to avoid duplicates
        const filtered = recentStocks.filter(stock => stock.symbol !== symbol);
        
        // Add to beginning
        filtered.unshift({
            symbol: symbol,
            name: name,
            price: price,
            timestamp: Date.now()
        });
        
        // Keep only last 5 viewed stocks
        const updated = filtered.slice(0, 5);
        localStorage.setItem('recently_viewed_stocks', JSON.stringify(updated));
        
        // Update recently viewed display if visible
        updateRecentlyViewedDisplay();
    }
    
    function updateRecentlyViewedDisplay() {
        const recentStocks = JSON.parse(localStorage.getItem('recently_viewed_stocks') || '[]');
        
        if (recentStocks.length === 0) return;
        
        // Could add recently viewed section to UI
        console.log('Recently viewed stocks:', recentStocks.map(s => s.symbol).join(', '));
    }

    function showError(message) {
        const resultsDiv = document.getElementById('search-results');
        resultsDiv.innerHTML = 
            '<div class="stock-result" style="text-align: center;">' +
                '<div style="color: var(--red); font-size: 2rem; margin-bottom: 1rem;"></div>' +
                '<div style="font-size: 1.1rem; margin-bottom: 0.5rem;">Search Error</div>' +
                '<div style="color: rgba(255,255,255,0.7);">' + message + '</div>' +
            '</div>';
        
        // Show suggestion cards again
        setTimeout(() => {
            document.querySelector('.suggestion-cards').style.display = 'flex';
        }, 3000);
    }

    // Search suggestions functionality
    function showSearchSuggestions(query) {
        const suggestionsDiv = document.getElementById('search-suggestions');
        const normalizedQuery = query.toLowerCase().trim();
        
        if (!query || query.length < 2) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        // Find matching companies
        const matches = [];
        for (const [company, symbol] of Object.entries(companyMap)) {
            if (company.includes(normalizedQuery) || normalizedQuery.includes(company)) {
                matches.push({ company, symbol });
            }
        }
        
        if (matches.length === 0) {
            suggestionsDiv.style.display = 'none';
            return;
        }
        
        // Display suggestions
        suggestionsDiv.innerHTML = matches.slice(0, 5).map(match => 
            '<div class="suggestion-item" onclick="selectSuggestion(\'' + match.symbol + '\', \'' + match.company + '\')">' +
                '<span class="suggestion-company">' + match.company + '</span>' +
                '<span class="suggestion-symbol">' + match.symbol + '</span>' +
            '</div>'
        ).join('');
        
        suggestionsDiv.style.display = 'block';
    }

    function selectSuggestion(symbol, company) {
        const input = document.getElementById('stock-search-input');
        input.value = company;
        document.getElementById('search-suggestions').style.display = 'none';
        searchStock(symbol);
        input.value = '';
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(event) {
        const suggestionsDiv = document.getElementById('search-suggestions');
        const searchInput = document.getElementById('stock-search-input');
        
        if (!suggestionsDiv.contains(event.target) && event.target !== searchInput) {
            suggestionsDiv.style.display = 'none';
        }
    });

    console.log('TradeWise AI: Intelligent ChatGPT-style search loaded');
    
    // Define all toggle functions in global scope
    window.copilotExpanded = false;
    window.themesExpanded = false;
    window.insightsExpanded = false;
    window.popularExpanded = false;
    

    




    // Search investment themes
    function searchTheme(themeName) {
        showLoadingState('Loading ' + themeName + ' investment theme...');
        
        setTimeout(() => {
            hideLoadingState();
            
            const themeCard = document.createElement('div');
            themeCard.className = 'stock-result theme-result';
            themeCard.id = 'theme-card-' + themeName;
            themeCard.innerHTML = 
                '<div class="stock-header">' +
                    '<div>' +
                        '<div class="stock-symbol">' + themeName + ' Investment Theme</div>' +
                        '<div class="stock-name">Curated investment opportunities</div>' +
                    '</div>' +
                    '<div class="theme-performance">' +
                        '<div class="price-change positive">' +
                            '<span class="performance-text">+' + getThemePerformance(themeName) + '% YTD</span>' +
                        '</div>' +
                    '</div>' +
                    '<div class="theme-controls">' +
                        '<button id="minimize-theme-btn-' + themeName + '" onclick="toggleThemeMinimize(\'' + themeName + '\')" class="minimize-btn" title="Minimize Theme">' +
                            '<i class="fas fa-minus"></i>' +
                        '</button>' +
                    '</div>' +
                '</div>'
                +
                '<div class="theme-details" id="theme-details-' + themeName + '">' +
                    '<div class="stock-metrics">' +
                        '<div class="metric">' +
                            '<div class="metric-label">Top Holdings</div>' +
                            '<div class="metric-value">' + getThemeStocks(themeName).join(', ') + '</div>' +
                        '</div>' +
                        '<div class="metric">' +
                            '<div class="metric-label">Market Focus</div>' +
                            '<div class="metric-value">' + getThemeDescription(themeName) + '</div>' +
                        '</div>' +
                        '<div class="metric">' +
                            '<div class="metric-label">Risk Level</div>' +
                            '<div class="metric-value">' + getThemeRisk(themeName) + '</div>' +
                        '</div>' +
                    '</div>' +
                    '<div class="ai-analysis">' +
                        '<div class="analysis-header">' +
                            '<i class="fas fa-brain"></i>' +
                            '<span>AI Theme Analysis</span>' +
                            '<span class="confidence-badge">90% confident</span>' +
                        '</div>' +
                        '<div class="analysis-content">' +
                            '<p>' + getThemeAnalysis(themeName) + '</p>' +
                        '</div>' +
                    '</div>' +
                    '<div class="stock-actions">' +
                        '<button class="action-btn primary" onclick="exploreTheme(\'' + themeName + '\')">' +
                            '<i class="fas fa-search"></i>' +
                            'Explore Theme' +
                        '</button>' +
                        '<button class="action-btn secondary" onclick="addStockToWatchlist(\'' + getThemeStocks(themeName)[0] + '\')">' +
                            '<i class="fas fa-bookmark"></i>' +
                            'Add to Watchlist' +
                        '</button>' +
                    '</div>' +
                '</div>';
            
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = '';
            resultsContainer.appendChild(themeCard);
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
        }, 1500);
    }

    function getThemePerformance(theme) {
        const performances = {
            'AI': '127', 'EV': '89', 'Crypto': '156', 'Biotech': '67',
            'Fintech': '45', 'Cloud': '78', 'Space': '112', 'CleanEnergy': '92',
            'Gaming': '34', 'ESG': '56', 'Defensive': '23', 'Emerging': '43'
        };
        return performances[theme] || '75';
    }

    function getThemeStocks(theme) {
        const stocks = {
            'AI': ['NVDA', 'GOOGL', 'MSFT', 'META'],
            'EV': ['TSLA', 'NIO', 'RIVN', 'LCID'],
            'Crypto': ['COIN', 'MSTR', 'RIOT', 'MARA'],
            'Biotech': ['MRNA', 'GILD', 'BIIB', 'VRTX'],
            'Fintech': ['SQ', 'PYPL', 'SOFI', 'AFRM'],
            'Cloud': ['CRM', 'SNOW', 'PLTR', 'NET']
        };
        return stocks[theme] || ['AAPL', 'MSFT', 'GOOGL', 'AMZN'];
    }

    function getThemeDescription(theme) {
        const descriptions = {
            'AI': 'Machine learning and automation technologies',
            'EV': 'Electric vehicles and charging infrastructure',
            'Crypto': 'Digital assets and blockchain technology',
            'Biotech': 'Drug development and medical innovation',
            'Fintech': 'Digital payments and financial services',
            'Cloud': 'Cloud computing and enterprise software'
        };
        return descriptions[theme] || 'Diversified growth opportunities';
    }

    function getThemeRisk(theme) {
        const risks = {
            'AI': 'Medium-High', 'EV': 'High', 'Crypto': 'Very High',
            'Biotech': 'High', 'Fintech': 'Medium-High', 'Cloud': 'Medium'
        };
        return risks[theme] || 'Medium';
    }

    function getThemeAnalysis(theme) {
        const analyses = {
            'AI': 'The artificial intelligence sector continues to show exceptional growth potential. Major tech companies are investing billions in AI infrastructure.',
            'EV': 'Electric vehicle adoption is accelerating globally, driven by environmental regulations and improving battery technology.',
            'Crypto': 'Cryptocurrency markets remain volatile but institutional adoption continues growing steadily.',
            'Biotech': 'Biotechnology companies are at the forefront of medical innovation with breakthrough therapies.'
        };
        return analyses[theme] || 'This investment theme offers diversified exposure to emerging growth trends with strong long-term potential.';
    }

    function exploreTheme(theme) {
        alert('Exploring ' + theme + ' theme in detail - feature coming soon!');
    }

    function addThemeToWatchlist(theme) {
        alert(theme + ' theme added to your watchlist!');
    }

    // Theme minimize functionality - completely hide theme
    function toggleThemeMinimize(themeName) {
        console.log('Minimizing theme:', themeName);
        
        // Find and hide the theme card completely
        const themeCard = document.getElementById('theme-card-' + themeName);
        if (themeCard) {
            themeCard.style.display = 'none';
            console.log('Theme card hidden:', themeName);
        }
        
        // Clear the search results container to show clean interface
        const resultsContainer = document.getElementById('search-results');
        if (resultsContainer) {
            resultsContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: rgba(255,255,255,0.5); font-style: italic;">Theme minimized. Use the search bar above to explore another stock or investment theme.</div>';
            console.log('Search results cleared');
        }
        
        // Remove any floating buttons that might exist (cleanup)
        const floatingButtons = document.querySelectorAll('[id^="floating-theme-"]');
        for (let i = 0; i < floatingButtons.length; i++) {
            floatingButtons[i].remove();
        }
        console.log('Cleanup completed');
    }

    // Note: Toggle functions are defined at the beginning of the script
    </script>

    <!-- Purchase Modal -->
    <div id="purchaseModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePurchaseModal()">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-shopping-cart"></i> Purchase Stock</h2>
            </div>
            <div class="modal-body">
                <div class="stock-info">
                    <div class="stock-details">
                        <div class="symbol" id="modalSymbol">AAPL</div>
                        <div class="name" id="modalName">Apple Inc.</div>
                        <div class="price" id="modalPrice">$150.00</div>
                    </div>
                    <div class="ai-insights">
                        <div class="recommendation" id="modalRecommendation">STRONG BUY</div>
                        <div class="confidence" id="modalConfidence">85% confidence</div>
                    </div>
                </div>
                
                <div class="account-info">
                    <div class="balance-display">
                        <span class="label">Account Balance:</span>
                        <span class="balance" id="accountBalance">$10,000.00</span>
                    </div>
                </div>

                <div class="purchase-form">
                    <div class="form-group">
                        <label for="shareQuantity">Number of Shares</label>
                        <input type="number" id="shareQuantity" min="1" value="1" onchange="updatePurchaseTotal()">
                    </div>
                    
                    <div class="purchase-summary">
                        <div class="summary-row">
                            <span>Price per Share:</span>
                            <span id="pricePerShare">$150.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total Cost:</span>
                            <span id="totalCost">$150.00</span>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closePurchaseModal()">Cancel</button>
                    <button class="modal-btn purchase" id="confirmPurchaseBtn" onclick="executePurchase()">
                        <i class="fas fa-credit-card"></i>
                        Purchase Shares
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Account Funding Modal -->
    <div id="fundingModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeFundingModal()">&times;</span>
            <div class="modal-header">
                <h2><i class="fas fa-wallet"></i> Add Funds</h2>
            </div>
            <div class="modal-body">
                <p>Add funds to your account to purchase stocks. Your money is securely processed by Stripe.</p>
                
                <div class="funding-options">
                    <div class="amount-preset" onclick="selectAmount(100)">$100</div>
                    <div class="amount-preset" onclick="selectAmount(500)">$500</div>
                    <div class="amount-preset" onclick="selectAmount(1000)">$1,000</div>
                    <div class="amount-preset" onclick="selectAmount(5000)">$5,000</div>
                </div>
                
                <div class="form-group">
                    <label for="customAmount">Or enter custom amount:</label>
                    <input type="number" id="customAmount" min="10" max="50000" placeholder="Enter amount ($10 - $50,000)">
                </div>

                <div class="modal-actions">
                    <button class="modal-btn cancel" onclick="closeFundingModal()">Cancel</button>
                    <button class="modal-btn purchase" onclick="processFunding()">
                        <i class="fas fa-credit-card"></i>
                        Add Funds
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
    /* Modal Styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
    }

    .modal-content {
        background: linear-gradient(145deg, #1a1a2e, #16213e);
        margin: 5% auto;
        padding: 0;
        border-radius: 20px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
        from { transform: translateY(-50px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
        padding: 1.5rem 3.5rem 1.5rem 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1));
        border-radius: 20px 20px 0 0;
        position: relative;
    }

    .modal-header h2 {
        margin: 0;
        color: white;
        font-size: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .modal-close {
        position: absolute;
        right: 1rem;
        top: 1rem;
        color: rgba(255, 255, 255, 0.6);
        font-size: 1.8rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        z-index: 1001;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
    }

    .modal-close:hover {
        color: white;
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }

    .modal-body {
        padding: 2rem;
    }

    .stock-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .stock-details .symbol {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
    }

    .stock-details .name {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
        margin: 0.25rem 0;
    }

    .stock-details .price {
        font-size: 1.25rem;
        font-weight: 600;
        color: #10b981;
    }

    .ai-insights {
        text-align: right;
    }

    .ai-insights .recommendation {
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .ai-insights .confidence {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .account-info {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .balance-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .balance-display .label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
    }

    .balance-display .balance {
        font-size: 1.1rem;
        font-weight: 600;
        color: #10b981;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: rgba(255, 255, 255, 0.8);
        font-weight: 500;
    }

    .form-group input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .form-group input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }

    .purchase-summary {
        margin-bottom: 1.5rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        color: rgba(255, 255, 255, 0.7);
    }

    .summary-row:last-child {
        margin-bottom: 0;
    }

    .summary-row.total {
        padding-top: 0.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        font-weight: 600;
        font-size: 1.1rem;
        color: white;
    }

    .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
    }

    .modal-btn {
        flex: 1;
        padding: 0.875rem 1.5rem;
        border: none;
        border-radius: 12px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        min-height: 48px;
    }

    .modal-btn.cancel {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-btn.cancel:hover {
        background: rgba(255, 255, 255, 0.15);
        color: white;
    }

    .modal-btn.purchase {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    .modal-btn.purchase:hover {
        background: linear-gradient(135deg, #059669, #047857);
        box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        transform: translateY(-2px);
    }

    .modal-btn.purchase:disabled {
        background: #6b7280;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Funding Modal Styles */
    .funding-options {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }

    .amount-preset {
        padding: 1rem;
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        text-align: center;
        font-weight: 600;
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .amount-preset:hover,
    .amount-preset.selected {
        background: linear-gradient(135deg, #10b981, #059669);
        border-color: #10b981;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
    }

    @media (max-width: 768px) {
        .modal-content {
            margin: 10% auto;
            width: 95%;
        }
        
        .modal-body {
            padding: 1.5rem;
        }
        
        .stock-info {
            flex-direction: column;
            text-align: center;
            gap: 1rem;
        }
        
        .ai-insights {
            text-align: center;
        }
        
        .funding-options {
            grid-template-columns: 1fr;
        }
    }
    </style>

    <script>
    let currentStock = {};
    let userBalance = 0;
    let selectedAmount = 0;

    // Load account balance
    async function loadAccountBalance() {
        try {
            const response = await fetch('/api/account-balance');
            const data = await response.json();
            userBalance = data.balance || 0;
            
            // Update balance displays
            const balanceElements = document.querySelectorAll('#accountBalance, .balance');
            balanceElements.forEach(el => {
                el.textContent = '$' + userBalance.toLocaleString('en-US', { minimumFractionDigits: 2 });
            });
        } catch (error) {
            console.error('TradeWise AI: Balance loading error:', error.message || error);
        }
    }

    // Show purchase modal
    function showPurchaseModal(symbol, name, price, recommendation, confidence) {
        currentStock = { symbol, name, price, recommendation, confidence };
        
        // Update modal content
        document.getElementById('modalSymbol').textContent = symbol;
        document.getElementById('modalName').textContent = name;
        document.getElementById('modalPrice').textContent = '$' + parseFloat(price).toFixed(2);
        document.getElementById('pricePerShare').textContent = '$' + parseFloat(price).toFixed(2);
        
        // Set recommendation styling
        const recommendationEl = document.getElementById('modalRecommendation');
        recommendationEl.textContent = recommendation;
        recommendationEl.className = 'recommendation ' + recommendation.toLowerCase().replace(/\s+/g, '-');
        
        // Apply the same color coding as main interface
        const rec = recommendation.toLowerCase();
        if (rec === 'strong buy') {
            recommendationEl.style.background = '#059669';
            recommendationEl.style.color = 'white';
        } else if (rec === 'buy') {
            recommendationEl.style.background = '#10b981';
            recommendationEl.style.color = 'white';
        } else if (rec === 'hold') {
            recommendationEl.style.background = '#fbbf24';
            recommendationEl.style.color = '#000000';
        } else if (rec === 'sell') {
            recommendationEl.style.background = '#ef4444';
            recommendationEl.style.color = 'white';
        } else if (rec === 'strong sell') {
            recommendationEl.style.background = '#dc2626';
            recommendationEl.style.color = 'white';
        }
        
        document.getElementById('modalConfidence').textContent = confidence + '% confidence';
        
        // Load current balance and update totals
        loadAccountBalance();
        updatePurchaseTotal();
        
        // Show modal
        document.getElementById('purchaseModal').style.display = 'block';
    }

    // Close purchase modal
    function closePurchaseModal() {
        document.getElementById('purchaseModal').style.display = 'none';
    }

    // Update purchase total
    function updatePurchaseTotal() {
        const quantity = parseInt(document.getElementById('shareQuantity').value) || 1;
        const pricePerShare = currentStock.price;
        const totalCost = quantity * pricePerShare;
        
        document.getElementById('totalCost').textContent = '$' + totalCost.toLocaleString('en-US', { minimumFractionDigits: 2 });
        
        // Enable/disable purchase button based on balance
        const purchaseBtn = document.getElementById('confirmPurchaseBtn');
        if (totalCost > userBalance) {
            purchaseBtn.disabled = true;
            purchaseBtn.innerHTML = '<i class="fas fa-wallet"></i> Insufficient Funds - Add Money';
            purchaseBtn.onclick = () => {
                closePurchaseModal();
                showFundingModal();
            };
        } else {
            purchaseBtn.disabled = false;
            purchaseBtn.innerHTML = '<i class="fas fa-credit-card"></i> Purchase Shares';
            purchaseBtn.onclick = executePurchase;
        }
    }

    // Execute purchase
    async function executePurchase() {
        const quantity = parseInt(document.getElementById('shareQuantity').value) || 1;
        const totalCost = quantity * currentStock.price;
        
        if (totalCost > userBalance) {
            showFundingModal();
            return;
        }
        
        try {
            const response = await fetch('/api/purchase-stock', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symbol: currentStock.symbol,
                    quantity: quantity,
                    price: currentStock.price
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Show success message
                alert('Successfully purchased ' + quantity + ' shares of ' + currentStock.symbol + ' for $' + totalCost.toFixed(2) + '!');
                
                // Close modal and refresh balance
                closePurchaseModal();
                loadAccountBalance();
            } else {
                alert('Error: ' + (result.message || 'Unable to complete purchase'));
            }
        } catch (error) {
            console.error('TradeWise AI: Purchase error', error);
            alert('Error processing purchase. Please try again.');
        }
    }

    // Add to watchlist
    async function addToWatchlist(symbol, name, price) {
        try {
            const response = await fetch('/api/add-to-watchlist', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    symbol: symbol,
                    name: name,
                    price: price
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                alert(symbol + ' added to your watchlist!');
            } else {
                alert('Error: ' + (result.message || 'Unable to add to watchlist'));
            }
        } catch (error) {
            console.error('TradeWise AI: Watchlist error', error);
            alert('Error adding to watchlist. Please try again.');
        }
    }

    // Show funding modal
    function showFundingModal() {
        selectedAmount = 0;
        document.getElementById('customAmount').value = '';
        document.querySelectorAll('.amount-preset').forEach(preset => {
            preset.classList.remove('selected');
        });
        document.getElementById('fundingModal').style.display = 'block';
    }

    // Close funding modal
    function closeFundingModal() {
        document.getElementById('fundingModal').style.display = 'none';
    }

    // Select funding amount
    function selectAmount(amount) {
        selectedAmount = amount;
        document.getElementById('customAmount').value = amount;
        
        // Update preset styling
        document.querySelectorAll('.amount-preset').forEach(preset => {
            preset.classList.remove('selected');
        });
        event.target.classList.add('selected');
    }

    // Process funding
    async function processFunding() {
        const customAmount = parseFloat(document.getElementById('customAmount').value);
        const amount = customAmount || selectedAmount;
        
        if (!amount || amount < 10 || amount > 50000) {
            alert('Please enter an amount between $10 and $50,000');
            return;
        }
        
        try {
            // Create Stripe checkout session
            const response = await fetch('/api/create-checkout-session', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    amount: amount
                })
            });
            
            const result = await response.json();
            
            if (result.checkout_url) {
                // Redirect to Stripe checkout
                window.location.href = result.checkout_url;
            } else {
                alert('Error: ' + (result.message || 'Unable to create payment session'));
            }
        } catch (error) {
            console.error('TradeWise AI: Funding error', error);
            alert('Error processing funding request. Please try again.');
        }
    }

    // Portfolio functionality
    let portfolioVisible = false;
    
    function togglePortfolio() {
        const portfolioSection = document.getElementById('portfolio-section');
        const searchContent = document.getElementById('search-content');
        
        // Close tools dropdown when portfolio is toggled
        document.getElementById('tools-dropdown-menu').classList.remove('show');
        toolsDropdownVisible = false;
        
        portfolioVisible = !portfolioVisible;
        
        if (portfolioVisible) {
            portfolioSection.style.display = 'block';
            searchContent.style.display = 'none';
            // Load enhanced portfolio data
            setTimeout(() => {
                loadEnhancedPortfolioData();
            }, 100);
        } else {
            portfolioSection.style.display = 'none';
            searchContent.style.display = 'block';
        }
    }
    
    // Tools Dropdown functionality
    let toolsDropdownVisible = false;
    
    function toggleToolsDropdown() {
        const dropdown = document.getElementById('tools-dropdown-menu');
        toolsDropdownVisible = !toolsDropdownVisible;
        
        if (toolsDropdownVisible) {
            dropdown.classList.add('show');
        } else {
            dropdown.classList.remove('show');
        }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.querySelector('.tools-dropdown');
        if (!dropdown.contains(event.target)) {
            document.getElementById('tools-dropdown-menu').classList.remove('show');
            toolsDropdownVisible = false;
        }
    });

    function toggleMarketIntelligence() {
        const content = document.getElementById('market-intelligence-content');
        if (content.style.display === 'none' || content.style.display === '') {
            content.style.display = 'block';
            // Initialize market intelligence if not already done
            if (typeof window.marketIntelligenceWidget === 'undefined') {
                window.marketIntelligenceWidget = new MarketIntelligenceWidget();
            }
            // Prevent scroll events from bubbling up
            content.addEventListener('wheel', function(e) {
                e.stopPropagation();
            });
            content.addEventListener('touchmove', function(e) {
                e.stopPropagation();
            });
        } else {
            content.style.display = 'none';
        }
        // Don't close the tools dropdown when toggling market intelligence
        event.stopPropagation();
    }

    // Enhanced Portfolio data loading function
    async function loadEnhancedPortfolioData() {
        console.log('Loading enhanced portfolio data...');
        try {
            // Ensure elements exist before trying to access them
            const loadingEl = document.getElementById('enhanced-portfolio-loading');
            const emptyEl = document.getElementById('enhanced-portfolio-empty');
            const gridEl = document.getElementById('enhanced-holdings-grid');
            
            if (loadingEl) loadingEl.style.display = 'block';
            if (emptyEl) emptyEl.style.display = 'none';
            if (gridEl) gridEl.style.display = 'none';
            
            const response = await fetch('/api/portfolio');
            const data = await response.json();
            
            // Update enhanced portfolio values with safety checks
            const totalValueEl = document.getElementById('enhanced-total-value');
            const totalInvestedEl = document.getElementById('enhanced-total-invested');
            const returnElement = document.getElementById('enhanced-total-return');
            
            if (totalValueEl) {
                totalValueEl.textContent = '$' + (data.total_value || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            }
            if (totalInvestedEl) {
                totalInvestedEl.textContent = '$' + (data.total_invested || 0).toLocaleString('en-US', {minimumFractionDigits: 2});
            }
            
            if (returnElement) {
                const totalReturn = (data.total_value || 0) - (data.total_invested || 0);
                returnElement.textContent = '$' + totalReturn.toLocaleString('en-US', {minimumFractionDigits: 2});
                returnElement.style.color = totalReturn >= 0 ? '#10b981' : '#ef4444';
            }
            
            if (loadingEl) loadingEl.style.display = 'none';
            
            // Update enhanced holdings
            if (gridEl && data.holdings && data.holdings.length > 0) {
                var holdingsHTML = '';
                for (var i = 0; i < data.holdings.length; i++) {
                    var holding = data.holdings[i];
                    holdingsHTML += '<div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 12px;">';
                    holdingsHTML += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
                    holdingsHTML += '<div style="display: flex; align-items: center; gap: 10px;">';
                    holdingsHTML += '<div style="background: linear-gradient(135deg, #3b82f6, #8b5cf6); color: white; padding: 4px 8px; border-radius: 6px; font-weight: 600; font-size: 0.8rem;">' + holding.symbol + '</div>';
                    holdingsHTML += '<div style="font-size: 0.85rem; color: rgba(255, 255, 255, 0.7);">' + holding.quantity + ' shares</div>';
                    holdingsHTML += '</div></div>';
                    holdingsHTML += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 8px; font-size: 0.75rem;">';
                    holdingsHTML += '<div style="text-align: center;"><div style="color: rgba(255, 255, 255, 0.5);">Avg Price</div><div style="font-weight: 600;">$' + (holding.avg_price || 0).toFixed(2) + '</div></div>';
                    holdingsHTML += '<div style="text-align: center;"><div style="color: rgba(255, 255, 255, 0.5);">Current</div><div style="font-weight: 600;">$' + (holding.current_price || holding.avg_price || 0).toFixed(2) + '</div></div>';
                    holdingsHTML += '<div style="text-align: center;"><div style="color: rgba(255, 255, 255, 0.5);">Value</div><div style="font-weight: 600;">$' + ((holding.current_price || holding.avg_price || 0) * holding.quantity).toFixed(2) + '</div></div>';
                    holdingsHTML += '</div></div>';
                }
                gridEl.innerHTML = holdingsHTML;
                gridEl.style.display = 'grid';
            } else {
                if (emptyEl) emptyEl.style.display = 'block';
            }
        } catch (error) {
            console.error('Error loading portfolio:', error);
            if (loadingEl) loadingEl.style.display = 'none';
            if (gridEl) {
                gridEl.innerHTML = '<div style="text-align: center; padding: 20px; color: rgba(255, 255, 255, 0.7);">Error loading portfolio data. Please try again.</div>';
                gridEl.style.display = 'block';
            }
        }
    }

    // Settings/Account functionality
    function openSettings() {
        // Close dropdown and show settings notification
        document.getElementById('tools-dropdown-menu').classList.remove('show');
        toolsDropdownVisible = false;
        showSimpleNotification('Account Settings feature coming soon!', 'info');
    }
    
    // Institutional Features functionality
    function openInstitutionalFeatures() {
        document.getElementById('tools-dropdown-menu').classList.remove('show');
        toolsDropdownVisible = false;
        window.open('/institutional', '_blank');
    }
    
    // Additional tool functions
    function showTradingHistory() {
        document.getElementById('tools-dropdown-menu').classList.remove('show');
        toolsDropdownVisible = false;
        alert('Trading History feature coming soon!');
    }
    
    function showWatchlist() {
        document.getElementById('tools-dropdown-menu').classList.remove('show');
        toolsDropdownVisible = false;
        toggleWatchlistModal();
    }
    
    function toggleWatchlistModal() {
        const modal = document.getElementById('watchlistModal');
        if (modal) {
            modal.style.display = 'block';
            loadUserWatchlists();
        }
    }
    
    function closeWatchlistModal() {
        const modal = document.getElementById('watchlistModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // Watchlist Management Functions
    function loadUserWatchlists() {
        fetch('/api/watchlists')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderWatchlists(data.watchlists);
                } else {
                    console.error('Error loading watchlists:', data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }
    
    function renderWatchlists(watchlists) {
        const container = document.getElementById('watchlistContainer');
        if (!container) return;
        
        let html = '';
        
        Object.entries(watchlists).forEach(([name, stocks]) => {
            html += '<div class="watchlist-group">';
            html += '<div class="watchlist-header" onclick="toggleWatchlistGroup(\'' + name + '\')">';
            html += '<div class="watchlist-name">';
            html += '<i class="fas fa-folder-open"></i>';
            html += '<span>' + name + '</span>';
            html += '<span class="watchlist-count">(' + stocks.length + ')</span>';
            html += '</div>';
            html += '<i class="fas fa-chevron-down watchlist-chevron" id="chevron-' + name.replace(/\s+/g, '') + '"></i>';
            html += '</div>';
            
            html += '<div class="watchlist-content" id="content-' + name.replace(/\s+/g, '') + '">';
            
            stocks.forEach(stock => {
                const changeClass = (stock.change_percent || 0) >= 0 ? 'positive' : 'negative';
                const changePrefix = (stock.change_percent || 0) >= 0 ? '+' : '';
                const rating = stock.professional_rating || 'BUY';
                const ratingClass = rating.toLowerCase().replace(/\s+/g, '-');
                
                html += '<div class="watchlist-stock-compact" onclick="searchStock(\'' + stock.symbol + '\')">';
                html += '<div class="stock-left">';
                html += '<div class="stock-symbol-large">' + stock.symbol + '</div>';
                html += '<div class="stock-name-small">' + (stock.company_name || stock.symbol).substring(0, 20) + '</div>';
                html += '</div>';
                html += '<div class="stock-center">';
                html += '<div class="stock-price-main">$' + (stock.current_price || 0).toFixed(2) + '</div>';
                html += '<div class="stock-change-compact ' + changeClass + '">' + changePrefix + (stock.change_percent || 0).toFixed(1) + '%</div>';
                html += '</div>';
                html += '<div class="stock-right">';
                html += '<div class="stock-rating-compact rating-' + ratingClass + '">' + rating + '</div>';
                html += '<button class="remove-btn-compact" onclick="event.stopPropagation(); removeFromWatchlist(\'' + name + '\', \'' + stock.symbol + '\')" title="Remove from watchlist">';
                html += '<i class="fas fa-times"></i>';
                html += '</button>';
                html += '</div>';
                html += '</div>';
            });
            
            html += '</div>';
            html += '</div>';
        });
        
        html += '<div class="watchlist-actions">';
        html += '<button class="watchlist-btn primary" onclick="showAddToWatchlistModal()">';
        html += '<i class="fas fa-plus"></i> Add Stock to Watchlist';
        html += '</button>';
        html += '<button class="watchlist-btn secondary" onclick="createNewWatchlist()">';
        html += '<i class="fas fa-folder-plus"></i> New Watchlist';
        html += '</button>';
        html += '</div>';
        
        container.innerHTML = html;
    }
    
    function toggleWatchlistGroup(name) {
        const content = document.getElementById('content-' + name.replace(/\s+/g, ''));
        const chevron = document.getElementById('chevron-' + name.replace(/\s+/g, ''));
        
        if (content && chevron) {
            content.classList.toggle('expanded');
            chevron.classList.toggle('rotated');
        }
    }
    
    function addToWatchlist(symbol, watchlistName = 'My Portfolio') {
        fetch('/api/watchlists/add', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol: symbol, watchlist_name: watchlistName })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadUserWatchlists();
                showNotification('success', data.message);
            } else {
                showNotification('error', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('error', 'Error adding to watchlist');
        });
    }
    
    function removeFromWatchlist(watchlistName, symbol) {
        fetch('/api/watchlists/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ watchlist_name: watchlistName, symbol: symbol })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadUserWatchlists();
                showNotification('success', data.message);
            } else {
                showNotification('error', data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('error', 'Error removing from watchlist');
        });
    }
    
    // Institutional Features function
    function openInstitutionalFeatures() {
        document.getElementById('tools-dropdown-menu').classList.remove('show');
        toolsDropdownVisible = false;
        window.open('/institutional-features', '_blank');
    }
    
    // Subscription Plans function
    function openSubscriptionPlans() {
        document.getElementById('tools-dropdown-menu').classList.remove('show');
        toolsDropdownVisible = false;
        
        // Ensure premium manager is available and try to show modal
        if (window.premiumManager && typeof window.premiumManager.showPremiumModal === 'function') {
            console.log('Using existing premium manager');
            window.premiumManager.showPremiumModal();
        } else if (window.PremiumManager) {
            console.log('Creating new premium manager');
            window.premiumManager = new PremiumManager();
            setTimeout(() => {
                window.premiumManager.showPremiumModal();
            }, 200);
        } else {
            console.log('Fallback: Direct modal display');
            // Direct fallback to show modal
            const modalElement = document.getElementById('premiumModal');
            if (modalElement) {
                if (typeof bootstrap !== 'undefined') {
                    const modal = new bootstrap.Modal(modalElement);
                    modal.show();
                } else {
                    modalElement.style.display = 'block';
                    modalElement.classList.add('show');
                }
            } else {
                console.error('Premium modal element not found in DOM');
                alert('Subscription plans are loading. Please wait a moment and try again.');
            }
        }
    }
    
    function loadPortfolioData() {
        // Load portfolio summary
        fetch('/api/portfolio-summary')
            .then(response => response.json())
            .then(data => {
                updatePortfolioDisplay(data);
            })
            .catch(error => {
                console.error('Error loading portfolio:', error);
                document.getElementById('portfolio-holdings').innerHTML = 
                    '<div class="loading-portfolio">' +
                        '<p style="color: #ef4444;">Error loading portfolio data</p>' +
                        '<p style="color: rgba(255,255,255,0.7); font-size: 0.9rem;">' +
                            'This might be because you haven\'t made any purchases yet, or you need to log in.' +
                        '</p>' +
                    '</div>';
            });
    }
    
    function updatePortfolioDisplay(data) {
        // Update header portfolio value
        const portfolioValue = document.getElementById('portfolio-value');
        portfolioValue.textContent = '$' + data.total_value.toFixed(2);
        
        // Update portfolio stats
        document.getElementById('total-portfolio-value').textContent = '$' + data.total_value.toFixed(2);
        document.getElementById('total-invested').textContent = '$' + data.total_invested.toFixed(2);
        
        const profitLoss = data.profit_loss;
        const profitLossElement = document.getElementById('profit-loss');
        profitLossElement.textContent = '$' + profitLoss.toFixed(2);
        profitLossElement.className = 'stat-value profit-loss ' + (profitLoss >= 0 ? 'positive' : 'negative');
        
        // Update holdings
        const holdingsContainer = document.getElementById('portfolio-holdings');
        
        if (data.holdings && data.holdings.length > 0) {
            var holdingsHTML = '';
            for (var i = 0; i < data.holdings.length; i++) {
                var holding = data.holdings[i];
                var plColor = holding.profit_loss >= 0 ? '#10b981' : '#ef4444';
                var plSign = holding.profit_loss >= 0 ? '+' : '';
                
                holdingsHTML += 
                    '<div class="holding-item">' +
                        '<div class="holding-header">' +
                            '<div class="holding-symbol">' + holding.symbol + '</div>' +
                            '<div class="holding-value">$' + holding.current_value.toFixed(2) + '</div>' +
                        '</div>' +
                        '<div class="holding-details">' +
                            '<div class="detail-small">' +
                                '<div>Shares</div>' +
                                '<div style="color: white;">' + holding.quantity + '</div>' +
                            '</div>' +
                            '<div class="detail-small">' +
                                '<div>Avg Cost</div>' +
                                '<div style="color: white;">$' + holding.avg_price.toFixed(2) + '</div>' +
                            '</div>' +
                            '<div class="detail-small">' +
                                '<div>Current</div>' +
                                '<div style="color: white;">$' + holding.current_price.toFixed(2) + '</div>' +
                            '</div>' +
                            '<div class="detail-small">' +
                                '<div>P&L</div>' +
                                '<div style="color: ' + plColor + ';">' +
                                    plSign + '$' + holding.profit_loss.toFixed(2) +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                        '<div class="holding-actions">' +
                            '<button class="holding-btn buy-btn" onclick="buyMoreStock(\'' + holding.symbol + '\')">' +
                                'Buy More' +
                            '</button>' +
                            '<button class="holding-btn sell-btn" onclick="sellStock(\'' + holding.symbol + '\')">' +
                                'Sell' +
                            '</button>' +
                        '</div>' +
                    '</div>';
            }
            holdingsContainer.innerHTML = holdingsHTML;
        } else {
            holdingsContainer.innerHTML = 
                '<div class="loading-portfolio">' +
                    '<p style="color: rgba(255,255,255,0.7);">No holdings yet</p>' +
                    '<p style="color: rgba(255,255,255,0.5); font-size: 0.9rem;">' +
                        'Start by searching for stocks and making your first purchase!' +
                    '</p>' +
                '</div>';
        }
    }
    
    function buyMoreStock(symbol) {
        // Get stock data and open purchase modal for existing holding
        fetch('/api/stock-analysis/' + symbol)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    openPurchaseModal(data);
                } else {
                    alert('Unable to get current data for ' + symbol + '. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error getting stock data:', error);
                alert('Error loading ' + symbol + ' data. Please try again.');
            });
    }

    function sellStock(symbol) {
        // For now, show a simple notification
        alert('Sell functionality for ' + symbol + ' coming soon!');
    }
    
    // Update portfolio summary when purchases are made
    function loadPortfolioSummary() {
        if (portfolioVisible) {
            loadPortfolioData();
        }
        
        // Always update the header value
        fetch('/api/portfolio-summary')
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP ' + response.status + ': ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data && typeof data.total_value === 'number') {
                    const portfolioValue = document.getElementById('portfolio-value');
                    if (portfolioValue) {
                        portfolioValue.textContent = '$' + data.total_value.toFixed(2);
                    }
                } else {
                    console.warn('Invalid portfolio data received:', data);
                }
            })
            .catch(error => {
                console.error('Error updating portfolio value:', error.message || error);
                // Graceful fallback - don't show error to user for this non-critical update
            });
    }

    // Load balance and portfolio on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAccountBalance();
        loadPortfolioSummary();
        
        // Initialize premium manager if available
        if (typeof PremiumManager !== 'undefined') {
            window.premiumManager = new PremiumManager();
            console.log('Premium Manager initialized on search page');
        }
    });

    // Close modals when clicking outside
    window.onclick = function(event) {
        const purchaseModal = document.getElementById('purchaseModal');
        const fundingModal = document.getElementById('fundingModal');
        
        if (event.target === purchaseModal) {
            closePurchaseModal();
        }
        if (event.target === fundingModal) {
            closeFundingModal();
        }
    };
    
    // Simple function to add stock to watchlist from search results
    async function addStockToWatchlist(symbol) {
        if (!symbol) {
            showSimpleNotification('No stock symbol provided', 'error');
            return;
        }
        
        try {
            const response = await fetch('/api/watchlists/add', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ 
                    symbol: symbol.toUpperCase(), 
                    watchlist_name: 'My Portfolio' 
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                showSimpleNotification(symbol + ' added to watchlist!', 'success');
            } else {
                showSimpleNotification('Error: ' + (result.message || 'Unable to add to watchlist'), 'error');
            }
        } catch (error) {
            console.error('Watchlist error:', error);
            showSimpleNotification('Error adding to watchlist. Please try again.', 'error');
        }
    }
    
    // Simple notification system
    function showSimpleNotification(message, type) {
        const notification = document.createElement('div');
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; padding: 12px 24px; border-radius: 8px; color: white; font-weight: 600; z-index: 10000; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); animation: slideIn 0.3s ease; background: ' + (type === 'success' ? '#00D4AA' : type === 'error' ? '#ef4444' : '#007AFF');
        notification.textContent = message;
        document.body.appendChild(notification);
        setTimeout(function() {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(function() { notification.remove(); }, 300);
        }, 3000);
    }
    
    // Show Add to Watchlist Modal
    function showAddToWatchlistModal() {
        const symbol = prompt("Enter stock symbol to add to watchlist:");
        if (symbol && symbol.trim()) {
            addStockToWatchlist(symbol.trim().toUpperCase());
            // Refresh watchlist display
            setTimeout(() => {
                loadUserWatchlists();
            }, 1000);
        }
    }
    
    // Create New Watchlist function
    function createNewWatchlist() {
        const name = prompt("Enter new watchlist name:");
        if (name && name.trim()) {
            showSimpleNotification('New watchlist "' + name + '" created!', 'success');
            // Refresh watchlist display
            setTimeout(() => {
                loadUserWatchlists();
            }, 1000);
        }
    }
    
    // Portfolio Builder Functions
    function startPortfolioQuestionnaire() {
        showPortfolioModal('questionnaire');
    }
    
    function showPortfolioStrategies() {
        showPortfolioModal('strategies');
    }
    
    function showPortfolioModal(type) {
        let modal = document.getElementById('portfolio-modal');
        if (!modal) {
            createPortfolioModal();
            modal = document.getElementById('portfolio-modal');
        }
        
        if (type === 'questionnaire') {
            loadQuestionnaire();
        } else if (type === 'strategies') {
            loadStrategies();
        }
        
        modal.style.display = 'flex';
    }
    
    function createPortfolioModal() {
        const modalHTML = '<div id="portfolio-modal" class="portfolio-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 10000; backdrop-filter: blur(4px);">' +
            '<div class="portfolio-modal-content" style="background: #1a1a1a; border-radius: 16px; width: min(700px, 95vw); max-height: 85vh; overflow-y: auto; border: 1px solid rgba(96, 165, 250, 0.2); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);">' +
                '<div class="portfolio-modal-header" style="padding: 1.5rem; border-bottom: 1px solid rgba(96, 165, 250, 0.1); display: flex; justify-content: space-between; align-items: center;">' +
                    '<h3 style="color: white; margin: 0; font-size: 1.2rem; font-weight: 600;"><i class="fas fa-robot"></i> AI Portfolio Builder</h3>' +
                    '<button class="portfolio-close-btn" onclick="closePortfolioModal()" style="background: none; border: none; color: rgba(255, 255, 255, 0.6); font-size: 1.5rem; cursor: pointer; padding: 0.5rem; border-radius: 8px;">' +
                        '<i class="fas fa-times"></i>' +
                    '</button>' +
                '</div>' +
                '<div class="portfolio-modal-body" id="portfolio-modal-body" style="padding: 1.5rem;">' +
                    '<div class="text-center">' +
                        '<i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #60a5fa;"></i>' +
                        '<p style="color: white;">Loading...</p>' +
                    '</div>' +
                '</div>' +
            '</div>' +
        '</div>';
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    function closePortfolioModal() {
        const modal = document.getElementById('portfolio-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    function loadQuestionnaire() {
        fetch('/api/portfolio-builder/questionnaire')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayQuestionnaire(data.questionnaire);
                } else {
                    showError('Failed to load questionnaire');
                }
            })
            .catch(error => {
                console.error('Error loading questionnaire:', error);
                showError('Failed to load questionnaire');
            });
    }
    
    function displayQuestionnaire(questionnaire) {
        let formHTML = '<div class="questionnaire-container">' +
            '<h4 style="color: white;">' + questionnaire.title + '</h4>' +
            '<p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 2rem;">' + questionnaire.description + '</p>' +
            '<form class="questionnaire-form" id="portfolio-questionnaire" style="display: flex; flex-direction: column; gap: 1.5rem;">';
        
        questionnaire.questions.forEach(question => {
            formHTML += '<div style="background: rgba(255, 255, 255, 0.02); padding: 1rem; border-radius: 8px; border: 1px solid rgba(96, 165, 250, 0.1);">';
            formHTML += '<label style="color: white; font-weight: 600; margin-bottom: 0.75rem; display: block;">' + question.question + '</label>';
            
            if (question.type === 'number') {
                formHTML += '<input type="number" style="width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 6px; padding: 0.75rem; color: white;" name="' + question.id + 
                    '" min="' + (question.min || '') + '" max="' + (question.max || '') + 
                    '" value="' + question.default + '">';
            } else if (question.type === 'select') {
                formHTML += '<select style="width: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 6px; padding: 0.75rem; color: white;" name="' + question.id + '">';
                question.options.forEach(option => {
                    const selected = option.value === question.default ? 'selected' : '';
                    formHTML += '<option value="' + option.value + '" ' + selected + ' style="background: #1a1a1a;">' + option.label + '</option>';
                });
                formHTML += '</select>';
            } else if (question.type === 'multi-select') {
                formHTML += '<div class="multi-select-options" data-name="' + question.id + '" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">';
                question.options.forEach(option => {
                    const selected = question.default.includes(option.value) ? 'selected' : '';
                    formHTML += '<div class="multi-select-option ' + selected + '" data-value="' + option.value + '" style="background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.2); color: white; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; font-size: 0.85rem;">' + option.label + '</div>';
                });
                formHTML += '</div>';
            }
            
            formHTML += '</div>';
        });
        
        formHTML += '<button type="submit" style="background: linear-gradient(135deg, #60a5fa, #3b82f6); border: none; color: white; padding: 1rem 2rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 1rem;">' +
            '<i class="fas fa-magic"></i> Create My Portfolio' +
            '</button>' +
            '</form></div>';
        
        document.getElementById('portfolio-modal-body').innerHTML = formHTML;
        
        // Add event listeners for multi-select
        document.querySelectorAll('.multi-select-option').forEach(option => {
            option.addEventListener('click', function() {
                this.classList.toggle('selected');
                if (this.classList.contains('selected')) {
                    this.style.background = 'rgba(96, 165, 250, 0.3)';
                    this.style.borderColor = 'rgba(96, 165, 250, 0.5)';
                } else {
                    this.style.background = 'rgba(96, 165, 250, 0.1)';
                    this.style.borderColor = 'rgba(96, 165, 250, 0.2)';
                }
            });
        });
        
        // Form submission
        document.getElementById('portfolio-questionnaire').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = {};
            
            // Regular form fields
            for (let [key, value] of formData.entries()) {
                data[key] = value;
            }
            
            // Multi-select fields
            document.querySelectorAll('.multi-select-options').forEach(container => {
                const name = container.dataset.name;
                const selected = Array.from(container.querySelectorAll('.multi-select-option.selected'))
                    .map(option => option.dataset.value);
                data[name] = selected;
            });
            
            // Type conversions
            if (data.age) data.age = parseInt(data.age);
            if (data.time_horizon) data.time_horizon = parseInt(data.time_horizon);
            if (data.investment_amount) data.investment_amount = parseFloat(data.investment_amount);
            
            // Get recommendations
            fetch('/api/portfolio-builder/recommendations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    displayRecommendations(result.recommendations, data);
                } else {
                    showSimpleNotification('Failed to get recommendations', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showSimpleNotification('Failed to get recommendations', 'error');
            });
        });
    }
    
    function displayRecommendations(recommendations, userData) {
        let html = '<div style="color: white;">' +
            '<h4>Recommended Portfolios for You</h4>' +
            '<p style="color: rgba(255, 255, 255, 0.7);">Based on your profile, here are our AI-recommended investment strategies:</p>' +
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem;">';
        
        recommendations.forEach((rec, index) => {
            const riskColor = rec.risk_level.toLowerCase().includes('low') ? '#22c55e' : 
                             rec.risk_level.toLowerCase().includes('medium') ? '#fbbf24' : '#ef4444';
            
            html += '<div onclick="selectStrategy(\'' + rec.strategy + '\', ' + userData.investment_amount + ')" style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(96, 165, 250, 0.15); border-radius: 12px; padding: 1.25rem; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background=\'rgba(96, 165, 250, 0.05)\'" onmouseout="this.style.background=\'rgba(255, 255, 255, 0.02)\'">' +
                '<div style="color: white; font-weight: 600; margin-bottom: 0.5rem;">' + rec.name + '</div>' +
                '<div style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin-bottom: 1rem;">' + rec.description + '</div>' +
                '<div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">' +
                    '<span style="background: rgba(' + (riskColor === '#22c55e' ? '34, 197, 94' : riskColor === '#fbbf24' ? '251, 191, 36' : '239, 68, 68') + ', 0.2); color: ' + riskColor + '; padding: 0.25rem 0.5rem; border-radius: 12px; font-weight: 500;">' + rec.risk_level + ' Risk</span>' +
                    '<span style="color: rgba(255, 255, 255, 0.8);">' + rec.expected_return + '</span>' +
                '</div>' +
                '<div style="margin-top: 0.75rem; font-size: 0.8rem; color: rgba(255, 255, 255, 0.6);">' +
                    'Match Score: ' + rec.score + '%' +
                '</div>' +
            '</div>';
        });
        
        html += '</div></div>';
        
        document.getElementById('portfolio-modal-body').innerHTML = html;
    }
    
    function selectStrategy(strategy, amount) {
        // Show loading
        document.getElementById('portfolio-modal-body').innerHTML = 
            '<div style="text-center; padding: 2rem; color: white;">' +
                '<i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #60a5fa; margin-bottom: 1rem;"></i>' +
                '<p>Building your personalized portfolio...</p>' +
            '</div>';
        
        fetch('/api/portfolio-builder/build', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                strategy: strategy,
                investment_amount: amount
            })
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                displayPortfolio(result.portfolio);
            } else {
                showSimpleNotification('Failed to build portfolio: ' + result.error, 'error');
                closePortfolioModal();
            }
        })
        .catch(error => {
            console.error('Error building portfolio:', error);
            showSimpleNotification('Failed to build portfolio', 'error');
            closePortfolioModal();
        });
    }
    
    function displayPortfolio(portfolio) {
        let html = '<div style="color: white;">' +
            '<h4><i class="fas fa-check-circle" style="color: #22c55e;"></i> Your AI-Built Portfolio</h4>' +
            '<div style="background: rgba(96, 165, 250, 0.05); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 12px; padding: 1.5rem; margin: 1rem 0;">' +
                '<h5 style="color: white; margin: 0 0 0.5rem 0;">' + portfolio.strategy.name + '</h5>' +
                '<p style="color: rgba(255, 255, 255, 0.7);">' + portfolio.strategy.description + '</p>' +
                '<div style="display: flex; gap: 2rem; margin-top: 1rem; flex-wrap: wrap;">' +
                    '<div><span style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">Total Investment</span><br><span style="color: white; font-weight: 600;">$' + portfolio.total_investment.toLocaleString() + '</span></div>' +
                    '<div><span style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">Risk Level</span><br><span style="color: white; font-weight: 600;">' + portfolio.strategy.risk_level + '</span></div>' +
                    '<div><span style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">Expected Return</span><br><span style="color: white; font-weight: 600;">' + portfolio.strategy.expected_return + '</span></div>' +
                '</div>' +
            '</div>' +
            '<h6 style="color: white;">Portfolio Holdings (' + portfolio.holdings.length + ' positions)</h6>' +
            '<div style="display: flex; flex-direction: column; gap: 0.75rem;">';
        
        portfolio.holdings.forEach(holding => {
            html += '<div style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(96, 165, 250, 0.1); border-radius: 8px; padding: 1rem; display: flex; justify-content: space-between; align-items: center;">' +
                '<div>' +
                    '<div style="color: white; font-weight: 600;">' + holding.symbol + '</div>' +
                    '<div style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">' + holding.shares + ' shares</div>' +
                '</div>' +
                '<div style="text-align: right;">' +
                    '<div style="color: rgba(255, 255, 255, 0.6); font-size: 0.8rem;">$' + holding.price + '</div>' +
                    '<div style="color: white; font-weight: 600;">$' + holding.amount.toLocaleString() + '</div>' +
                '</div>' +
            '</div>';
        });
        
        html += '</div>' +
            '<div style="margin-top: 2rem; text-align: center;">' +
                '<button onclick="implementPortfolio()" style="background: linear-gradient(135deg, #60a5fa, #3b82f6); border: none; color: white; padding: 1rem 2rem; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-right: 1rem;">' +
                    '<i class="fas fa-rocket"></i> Implement Portfolio' +
                '</button>' +
                '<button onclick="startPortfolioQuestionnaire()" style="background: transparent; border: 1px solid rgba(96, 165, 250, 0.3); color: white; padding: 1rem 2rem; border-radius: 8px; cursor: pointer;">' +
                    '<i class="fas fa-redo"></i> Try Different Strategy' +
                '</button>' +
            '</div>' +
        '</div>';
        
        document.getElementById('portfolio-modal-body').innerHTML = html;
    }
    
    function implementPortfolio() {
        showSimpleNotification('Portfolio implementation coming soon! For now, use individual stock purchases.', 'info');
        closePortfolioModal();
    }
    
    function loadStrategies() {
        fetch('/api/portfolio-builder/strategies')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayStrategies(data.strategies);
                } else {
                    showSimpleNotification('Failed to load strategies', 'error');
                }
            })
            .catch(error => {
                console.error('Error loading strategies:', error);
                showSimpleNotification('Failed to load strategies', 'error');
            });
    }
    
    function displayStrategies(strategies) {
        let html = '<div style="color: white;">' +
            '<h4>Available Investment Strategies</h4>' +
            '<p style="color: rgba(255, 255, 255, 0.7);">Choose a strategy that matches your risk tolerance and goals:</p>' +
            '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; margin-top: 1rem;">';
        
        strategies.forEach(strategy => {
            const riskColor = strategy.risk_level.toLowerCase().includes('low') ? '#22c55e' : 
                             strategy.risk_level.toLowerCase().includes('medium') ? '#fbbf24' : '#ef4444';
            
            html += '<div onclick="selectStrategyDirect(\'' + strategy.id + '\')" style="background: rgba(255, 255, 255, 0.02); border: 1px solid rgba(96, 165, 250, 0.15); border-radius: 12px; padding: 1.25rem; cursor: pointer; transition: all 0.3s ease;" onmouseover="this.style.background=\'rgba(96, 165, 250, 0.05)\'" onmouseout="this.style.background=\'rgba(255, 255, 255, 0.02)\'">' +
                '<div style="color: white; font-weight: 600; margin-bottom: 0.5rem;">' + strategy.name + '</div>' +
                '<div style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin-bottom: 1rem;">' + strategy.description + '</div>' +
                '<div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem;">' +
                    '<span style="background: rgba(' + (riskColor === '#22c55e' ? '34, 197, 94' : riskColor === '#fbbf24' ? '251, 191, 36' : '239, 68, 68') + ', 0.2); color: ' + riskColor + '; padding: 0.25rem 0.5rem; border-radius: 12px; font-weight: 500;">' + strategy.risk_level + ' Risk</span>' +
                    '<span style="color: rgba(255, 255, 255, 0.8);">' + strategy.expected_return + '</span>' +
                '</div>' +
            '</div>';
        });
        
        html += '</div>' +
            '<div style="margin-top: 2rem; text-align: center;">' +
                '<button onclick="startPortfolioQuestionnaire()" style="background: rgba(96, 165, 250, 0.2); border: 1px solid rgba(96, 165, 250, 0.5); color: white; padding: 1rem 2rem; border-radius: 8px; cursor: pointer;">' +
                    '<i class="fas fa-magic"></i> Get Personalized Recommendation' +
                '</button>' +
            '</div>' +
        '</div>';
        
        document.getElementById('portfolio-modal-body').innerHTML = html;
    }
    
    function selectStrategyDirect(strategyId) {
        const amount = prompt('Enter investment amount ($):');
        if (amount && !isNaN(amount) && parseFloat(amount) >= 100) {
            selectStrategy(strategyId, parseFloat(amount));
        } else {
            showSimpleNotification('Please enter a valid amount ($100 minimum)', 'error');
        }
    }
    
    // Ensure all missing functions exist for smooth UI operation
    if (typeof openSubscriptionPlans === 'undefined') {
        function openSubscriptionPlans() {
            if (typeof PremiumManager !== 'undefined' && PremiumManager.showSubscriptionModal) {
                PremiumManager.showSubscriptionModal();
            } else {
                showSimpleNotification('Premium subscription plans coming soon!', 'info');
            }
        }
    }
    
    // UI consistency improvements
    function improveUISpacing() {
        // Ensure all buttons have consistent minimum height for touch-friendly interaction
        const buttons = document.querySelectorAll('button');
        buttons.forEach(button => {
            if (!button.style.minHeight) {
                button.style.minHeight = '44px';
                button.style.display = 'flex';
                button.style.alignItems = 'center';
                button.style.justifyContent = 'center';
            }
        });
        
        // Center all modal content properly
        const modals = document.querySelectorAll('.modal-content, .portfolio-modal-content, .watchlist-modal-content');
        modals.forEach(modal => {
            modal.style.margin = '2rem auto';
            modal.style.maxWidth = '90vw';
            modal.style.borderRadius = '12px';
        });
        
        // Ensure dropdown positioning
        const dropdowns = document.querySelectorAll('.tools-dropdown-menu');
        dropdowns.forEach(dropdown => {
            dropdown.style.position = 'absolute';
            dropdown.style.top = '100%';
            dropdown.style.right = '0';
            dropdown.style.zIndex = '1000';
        });
    }
    
    // Apply UI improvements on DOM ready
    document.addEventListener('DOMContentLoaded', improveUISpacing);
    setTimeout(improveUISpacing, 1000); // Backup for dynamic content
    </script>
    
    <!-- Include Premium Modal -->
    {% include 'premium_modal.html' %}
    
    <!-- Premium JavaScript -->
    <script src="{{ url_for('static', filename='js/premium.js') }}"></script>
    <script>
        // Institutional Contact Functions
        function openInstitutionalContact() {
            window.location.href = '/institutional-contact';
        }
        
        function openSettings() {
            window.location.href = '/settings';
        }
        
        console.log('Institutional contact functions loaded');
    </script>
    

    
    <!-- AI Team Interactive Modal -->
    <div id="ai-team-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 16px; padding: 0; max-width: 600px; width: 90%; max-height: 80vh; margin: 2rem; color: white; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.4);">
            <!-- Header -->
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h3 style="margin: 0; font-size: 1.2rem; font-weight: 700;"> AI Support Team</h3>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Choose a specialist or let us auto-route your question</p>
                    </div>
                    <button onclick="closeAITeamModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <!-- Team Members -->
            <div style="padding: 1.5rem; max-height: 50vh; overflow-y: auto;">
                <div id="team-members-container">
                    <!-- Auto-Route Option -->
                    <div class="team-member-card" onclick="selectTeamMember('auto')" style="display: flex; align-items: center; padding: 1rem; background: rgba(96,165,250,0.1); border: 1px solid rgba(96,165,250,0.2); border-radius: 12px; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                            <i class="fas fa-robot" style="font-size: 1.2rem; color: white;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">Smart Auto-Route</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">AI will automatically choose the best specialist for your question</div>
                        </div>
                        <div style="width: 12px; height: 12px; background: #00D4AA; border-radius: 50%; margin-left: 1rem;"></div>
                    </div>
                    
                    <!-- Sarah Chen -->
                    <div class="team-member-card" onclick="selectTeamMember('sarah')" style="display: flex; align-items: center; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #00D4AA, #007AFF); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                            <i class="fas fa-chart-line" style="font-size: 1.2rem; color: white;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">Sarah Chen</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">AI Market Analyst - Trading strategies, market insights, stock analysis</div>
                        </div>
                        <div style="width: 12px; height: 12px; background: #00D4AA; border-radius: 50%; margin-left: 1rem;"></div>
                    </div>
                    
                    <!-- Alex Rodriguez -->
                    <div class="team-member-card" onclick="selectTeamMember('alex')" style="display: flex; align-items: center; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #FF6B35, #F7931E); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                            <i class="fas fa-tools" style="font-size: 1.2rem; color: white;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">Alex Rodriguez</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">Technical Support - Platform issues, account help, feature guidance</div>
                        </div>
                        <div style="width: 12px; height: 12px; background: #00D4AA; border-radius: 50%; margin-left: 1rem;"></div>
                    </div>
                    
                    <!-- Maria Santos -->
                    <div class="team-member-card" onclick="selectTeamMember('maria')" style="display: flex; align-items: center; padding: 1rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; margin-bottom: 1rem; cursor: pointer; transition: all 0.3s;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #8B5CF6, #A855F7); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 1rem;">
                            <i class="fas fa-graduation-cap" style="font-size: 1.2rem; color: white;"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; font-size: 1rem; margin-bottom: 0.25rem;">Maria Santos</div>
                            <div style="color: rgba(255,255,255,0.7); font-size: 0.85rem;">Customer Success - Getting started, feature tutorials, best practices</div>
                        </div>
                        <div style="width: 12px; height: 12px; background: #00D4AA; border-radius: 50%; margin-left: 1rem;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Chat Interface (Initially Hidden) -->
            <div id="chat-interface" style="display: none; padding: 1.5rem; border-top: 1px solid rgba(255,255,255,0.1);">
                <div id="selected-member-info" style="display: flex; align-items: center; margin-bottom: 1rem; padding: 0.75rem; background: rgba(96,165,250,0.1); border-radius: 8px;">
                    <div id="selected-avatar" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 0.75rem;"></div>
                    <div>
                        <div id="selected-name" style="font-weight: 600; font-size: 0.9rem;"></div>
                        <div id="selected-role" style="color: rgba(255,255,255,0.7); font-size: 0.8rem;"></div>
                    </div>
                    <button onclick="backToTeamSelection()" style="margin-left: auto; background: rgba(255,255,255,0.1); border: none; color: white; padding: 0.5rem; border-radius: 6px; cursor: pointer;">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                
                <div style="display: flex; gap: 0.75rem; margin-bottom: 1rem;">
                    <input type="text" id="team-chat-input" placeholder="Ask your question..." style="flex: 1; padding: 0.75rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; background: rgba(255,255,255,0.05); color: white; outline: none;" onkeypress="if(event.key==='Enter') sendTeamMessage()">
                    <button onclick="sendTeamMessage()" style="background: #667eea; border: none; color: white; padding: 0.75rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600;">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                
                <div id="chat-messages" style="max-height: 200px; overflow-y: auto; padding: 0.75rem; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 0.9rem; line-height: 1.4;">
                    <div style="color: rgba(255,255,255,0.7); text-align: center; font-style: italic;">Start a conversation with your selected AI specialist...</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
    // AI Team launcher functionality
    let selectedMember = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        const launcher = document.getElementById('ai-team-launcher');
        const modal = document.getElementById('ai-team-modal');
        
        if (launcher && modal) {
            const tooltip = launcher.querySelector('.launcher-tooltip');
            
            launcher.addEventListener('click', function() {
                modal.style.display = 'flex';
                showTeamSelection();
                console.log('AI Team launcher clicked - showing team selection');
            });
            
            launcher.addEventListener('mouseenter', function() {
                if (tooltip) tooltip.style.opacity = '1';
            });
            
            launcher.addEventListener('mouseleave', function() {
                if (tooltip) tooltip.style.opacity = '0';
            });
            
            console.log('AI Team launcher initialized successfully');
        } else {
            console.log('AI Team launcher not found - feature disabled');
        }
        
        // Add hover effects to team member cards
        document.addEventListener('mouseover', function(e) {
            if (e.target.closest('.team-member-card')) {
                const card = e.target.closest('.team-member-card');
                card.style.background = 'rgba(96,165,250,0.15)';
                card.style.borderColor = 'rgba(96,165,250,0.3)';
                card.style.transform = 'translateY(-2px)';
            }
        });
        
        document.addEventListener('mouseout', function(e) {
            if (e.target.closest('.team-member-card')) {
                const card = e.target.closest('.team-member-card');
                if (!card.onclick.toString().includes('auto')) {
                    card.style.background = 'rgba(255,255,255,0.05)';
                    card.style.borderColor = 'rgba(255,255,255,0.1)';
                } else {
                    card.style.background = 'rgba(96,165,250,0.1)';
                    card.style.borderColor = 'rgba(96,165,250,0.2)';
                }
                card.style.transform = 'translateY(0)';
            }
        });
    });
    
    function closeAITeamModal() {
        const modal = document.getElementById('ai-team-modal');
        modal.style.display = 'none';
        showTeamSelection();
    }
    
    function showTeamSelection() {
        document.getElementById('team-members-container').parentElement.style.display = 'block';
        document.getElementById('chat-interface').style.display = 'none';
    }
    
    function selectTeamMember(memberType) {
        selectedMember = memberType;
        console.log('Selected team member:', memberType);
        
        // Hide team selection, show chat interface
        document.getElementById('team-members-container').parentElement.style.display = 'none';
        document.getElementById('chat-interface').style.display = 'block';
        
        // Update selected member info
        const avatar = document.getElementById('selected-avatar');
        const name = document.getElementById('selected-name');
        const role = document.getElementById('selected-role');
        const messages = document.getElementById('chat-messages');
        
        let memberData = {};
        
        switch(memberType) {
            case 'auto':
                memberData = {
                    name: 'Smart Auto-Route',
                    role: 'AI will choose the best specialist',
                    avatar: '<i class="fas fa-robot" style="color: white;"></i>',
                    background: 'linear-gradient(135deg, #667eea, #764ba2)',
                    greeting: 'Hi! I\'ll analyze your question and connect you with the right specialist. What can I help you with?'
                };
                break;
            case 'sarah':
                memberData = {
                    name: 'Sarah Chen',
                    role: 'AI Market Analyst',
                    avatar: '<i class="fas fa-chart-line" style="color: white;"></i>',
                    background: 'linear-gradient(135deg, #00D4AA, #007AFF)',
                    greeting: 'Hello! I\'m Sarah, your AI Market Analyst. I can help with trading strategies, market insights, and stock analysis. What would you like to explore?'
                };
                break;
            case 'alex':
                memberData = {
                    name: 'Alex Rodriguez',
                    role: 'Technical Support Specialist',
                    avatar: '<i class="fas fa-tools" style="color: white;"></i>',
                    background: 'linear-gradient(135deg, #FF6B35, #F7931E)',
                    greeting: 'Hey there! I\'m Alex, your Technical Support specialist. I can help with platform issues, account problems, and feature guidance. How can I assist you today?'
                };
                break;
            case 'maria':
                memberData = {
                    name: 'Maria Santos',
                    role: 'Customer Success Manager',
                    avatar: '<i class="fas fa-graduation-cap" style="color: white;"></i>',
                    background: 'linear-gradient(135deg, #8B5CF6, #A855F7)',
                    greeting: 'Hi! I\'m Maria, your Customer Success Manager. I\'m here to help you get started, learn new features, and share best practices. What can I help you with?'
                };
                break;
        }
        
        // Update UI with selected member
        avatar.style.background = memberData.background;
        avatar.innerHTML = memberData.avatar;
        name.textContent = memberData.name;
        role.textContent = memberData.role;
        
        // Show greeting message
        messages.innerHTML = 
            '<div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(96,165,250,0.1); border-radius: 8px; border-left: 3px solid #667eea;">' +
                '<div style="font-weight: 600; color: #667eea; margin-bottom: 0.25rem;">' + memberData.name + '</div>' +
                '<div style="color: rgba(255,255,255,0.9);">' + memberData.greeting + '</div>' +
                '<div style="color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-top: 0.5rem;">Just now</div>' +
            '</div>';
        
        // Focus on input
        document.getElementById('team-chat-input').focus();
    }
    
    function backToTeamSelection() {
        showTeamSelection();
        selectedMember = null;
    }
    
    async function sendTeamMessage() {
        const input = document.getElementById('team-chat-input');
        const messages = document.getElementById('chat-messages');
        const message = input.value.trim();
        
        if (!message) return;
        
        // Add user message
        const userMessage = document.createElement('div');
        userMessage.style.cssText = 'margin-bottom: 1rem; text-align: right;';
        userMessage.innerHTML = 
            '<div style="display: inline-block; max-width: 80%; padding: 0.75rem; background: rgba(96,165,250,0.2); border-radius: 8px; text-align: left;">' +
                '<div style="color: white; margin-bottom: 0.25rem;">' + message + '</div>' +
                '<div style="color: rgba(255,255,255,0.5); font-size: 0.8rem; text-align: right;">Just now</div>' +
            '</div>';
        messages.appendChild(userMessage);
        
        input.value = '';
        messages.scrollTop = messages.scrollHeight;
        
        // Show typing indicator
        const typingIndicator = document.createElement('div');
        typingIndicator.id = 'typing-indicator';
        typingIndicator.style.cssText = 'margin-bottom: 1rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;';
        typingIndicator.innerHTML = 
            '<div style="color: rgba(255,255,255,0.7); font-style: italic;">' +
                '<i class="fas fa-circle" style="font-size: 0.5rem; opacity: 0.5; animation: pulse 1.5s infinite;"></i>' +
                '<i class="fas fa-circle" style="font-size: 0.5rem; opacity: 0.5; animation: pulse 1.5s infinite 0.3s;"></i>' +
                '<i class="fas fa-circle" style="font-size: 0.5rem; opacity: 0.5; animation: pulse 1.5s infinite 0.6s;"></i>' +
                'AI is thinking...' +
            '</div>';
        messages.appendChild(typingIndicator);
        messages.scrollTop = messages.scrollHeight;
        
        try {
            // Send to AI team backend
            const response = await fetch('/api/ai-team/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                credentials: 'same-origin',
                body: JSON.stringify({
                    query: message,
                    member: selectedMember,
                    context: 'trading_platform'
                })
            });
            
            const result = await response.json();
            
            // Remove typing indicator
            messages.removeChild(typingIndicator);
            
            if (result.success) {
                // Add AI response with enhanced formatting
                const aiMessage = document.createElement('div');
                aiMessage.style.cssText = 'margin-bottom: 1rem;';
                
                const response = result.response;
                let messageContent = response.message;
                
                // Add suggested actions if available
                if (response.suggested_actions && response.suggested_actions.length > 0) {
                    messageContent += '\n\n Suggested Actions:\n';
                    response.suggested_actions.forEach((action, index) => {
                        messageContent += (index + 1) + '. ' + action + '\n';
                    });
                }
                
                // Add troubleshooting steps if available (for Alex)
                if (response.troubleshooting_steps && response.troubleshooting_steps.length > 0) {
                    messageContent += '\n\n Try these steps:\n';
                    response.troubleshooting_steps.forEach(step => {
                        messageContent += ' ' + step + '\n';
                    });
                }
                
                // Add quick guides if available (for Maria)
                if (response.quick_guides && response.quick_guides.length > 0) {
                    messageContent += '\n\n Quick Guides:\n';
                    response.quick_guides.forEach(guide => {
                        messageContent += ' ' + guide + '\n';
                    });
                }
                
                // Add AI confidence if available (for Sarah)
                if (response.ai_confidence) {
                    messageContent += '\n\n AI Analysis Accuracy: ' + response.ai_confidence;
                }
                
                aiMessage.innerHTML = 
                    '<div style="padding: 0.75rem; background: rgba(96,165,250,0.1); border-radius: 8px; border-left: 3px solid #667eea;">' +
                        '<div style="font-weight: 600; color: #667eea; margin-bottom: 0.25rem;">' + (response.member || response.member_name) + '</div>' +
                        '<div style="color: rgba(255,255,255,0.9); line-height: 1.4; white-space: pre-line;">' + messageContent + '</div>' +
                        '<div style="color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-top: 0.5rem;">Just now</div>' +
                    '</div>';
                messages.appendChild(aiMessage);
            } else {
                // Show error message
                const errorMessage = document.createElement('div');
                errorMessage.innerHTML = 
                    '<div style="padding: 0.75rem; background: rgba(239,68,68,0.1); border-radius: 8px; border-left: 3px solid #ef4444; color: rgba(255,255,255,0.9);">' +
                        'Sorry, I\'m having trouble connecting right now. Please try again in a moment.' +
                    '</div>';
                messages.appendChild(errorMessage);
            }
            
        } catch (error) {
            messages.removeChild(typingIndicator);
            console.error('Error sending message:', error);
            
            // Provide intelligent fallback responses based on selected member and question
            const fallbackResponse = generateIntelligentFallback(selectedMember, message);
            const fallbackMessage = document.createElement('div');
            fallbackMessage.innerHTML = 
                '<div style="padding: 0.75rem; background: rgba(96,165,250,0.1); border-radius: 8px; border-left: 3px solid #667eea;">' +
                    '<div style="font-weight: 600; color: #667eea; margin-bottom: 0.25rem;">' + fallbackResponse.name + '</div>' +
                    '<div style="color: rgba(255,255,255,0.9);">' + fallbackResponse.message + '</div>' +
                    '<div style="color: rgba(255,255,255,0.5); font-size: 0.8rem; margin-top: 0.5rem;">Just now</div>' +
                '</div>';
            messages.appendChild(fallbackMessage);
        }
        
        messages.scrollTop = messages.scrollHeight;
    }
    
    // Generate intelligent fallback responses based on team member and query
    function generateIntelligentFallback(memberType, query) {
        const queryLower = query.toLowerCase();
        
        switch(memberType) {
            case 'sarah':
                if (queryLower.includes('stock') || queryLower.includes('buy') || queryLower.includes('sell')) {
                    return {
                        name: 'Sarah Chen',
                        message: 'Great question about ' + (query.includes('stock') ? 'stock analysis' : 'trading') + '! Based on current market conditions, I\'d recommend using our main search to get real-time AI analysis for specific stocks. You can search for any company like "Apple" or "Tesla" to get my comprehensive analysis with confidence ratings and trading recommendations.'
                    };
                } else if (queryLower.includes('market') || queryLower.includes('trend')) {
                    return {
                        name: 'Sarah Chen',
                        message: 'For market analysis, I use advanced AI algorithms to track market trends and volatility. Try our Investment Themes dropdown to see AI-powered sector analysis, or search for specific stocks to get detailed market insights with my 85%+ accuracy ratings.'
                    };
                } else {
                    return {
                        name: 'Sarah Chen',
                        message: 'As your AI Market Analyst, I specialize in stock analysis, market trends, and trading strategies. Use our intelligent search feature to get my real-time analysis on any stock - just type a company name and I\'ll provide detailed insights with confidence scores!'
                    };
                }
                
            case 'alex':
                if (queryLower.includes('problem') || queryLower.includes('error') || queryLower.includes('not working')) {
                    return {
                        name: 'Alex Rodriguez',
                        message: 'I understand you\'re experiencing an issue. Most platform problems can be resolved quickly: 1) Try refreshing the page, 2) Clear your browser cache, 3) Check if you\'re logged in properly. If you\'re having trouble with specific features, the main search and dropdowns should be working perfectly!'
                    };
                } else if (queryLower.includes('account') || queryLower.includes('login')) {
                    return {
                        name: 'Alex Rodriguez',
                        message: 'For account issues, make sure you\'re properly logged in. You can create a demo account to test all features. If you need to deposit funds for real trading, use the "Upgrade" button to access our secure payment system.'
                    };
                } else {
                    return {
                        name: 'Alex Rodriguez',
                        message: 'I\'m here to help with any technical issues! The platform is running smoothly with all core features operational: intelligent search, real-time stock data, AI analysis, and secure trading. What specific feature can I help you with?'
                    };
                }
                
            case 'maria':
                if (queryLower.includes('how') || queryLower.includes('start') || queryLower.includes('learn')) {
                    return {
                        name: 'Maria Santos',
                        message: 'Perfect! I love helping users get started. Here\'s the best way to begin: 1) Try our intelligent search - just type "Apple" or any company name, 2) Explore our Investment Themes for diversified portfolios, 3) Check Market Insights for live data. Our AI provides recommendations with confidence scores to guide your decisions!'
                    };
                } else if (queryLower.includes('feature') || queryLower.includes('tool')) {
                    return {
                        name: 'Maria Santos',
                        message: 'Our platform has amazing features! The intelligent search converts company names to tickers automatically, provides AI analysis with 85%+ accuracy, real-time market data, and professional trading recommendations. Try searching for any stock to see the AI magic in action!'
                    };
                } else {
                    return {
                        name: 'Maria Santos',
                        message: 'Welcome! I\'m here to help you succeed with TradeWise AI. Our platform makes professional trading accessible to everyone with AI-powered insights, real-time data, and intelligent recommendations. What would you like to explore first?'
                    };
                }
                
            default: // auto
                return {
                    name: 'Smart Auto-Route',
                    message: 'I\'ve analyzed your question and I\'m connecting you with our intelligent trading system. Use our main search feature to get instant AI-powered stock analysis, explore Investment Themes for portfolio ideas, or check Market Insights for real-time data. Our AI provides professional-grade analysis with confidence ratings!'
                };
        }
    }
    
    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
        const modal = document.getElementById('ai-team-modal');
        if (e.target === modal) {
            closeAITeamModal();
        }
    });

    // Initialize subscription system - ADDED to fix JavaScript error
    function initializeSubscription(targetTier) {
        console.log("Initializing " + targetTier + " subscription...");
        // This would integrate with Stripe in production
        alert(targetTier + " subscription coming soon! This will unlock advanced features.");
    }

    // Make functions globally available
    window.initializeSubscription = initializeSubscription;
    
    // Add missing showUpgradeModal function
    window.showUpgradeModal = function(targetTier) {
        if (window.tierIntegration && window.tierIntegration.openSubscriptionUpgrade) {
            window.tierIntegration.openSubscriptionUpgrade(targetTier);
        } else {
            // Fallback
            alert(targetTier + " subscription upgrade coming soon!");
        }
    };
    </script>
    


</body>
</html><!-- Cache bust: 1752968128 -->
