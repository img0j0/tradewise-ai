<!-- Enhanced Alerts Tab Content -->
<div id="alerts-content" class="tab-content" style="display: none;">
    <div class="container-fluid" style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h3 style="margin: 0; color: white;">Smart Stock Alerts</h3>
            <div style="display: flex; gap: 10px;">
                <button onclick="checkAllAlerts()" style="padding: 10px 20px; background: linear-gradient(45deg, #8b5cf6, #7c3aed); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                    ðŸ”„ Check Alerts
                </button>
                <button onclick="viewActiveAlerts()" style="padding: 10px 20px; background: linear-gradient(45deg, #10b981, #059669); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 600;">
                    ðŸ“‹ View All Alerts
                </button>
            </div>
        </div>

        <!-- Alert Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 15px; padding: 20px; text-align: center;">
                <div style="font-size: 2rem; font-weight: 700; color: #10b981; margin-bottom: 10px;" id="active-alerts-count">0</div>
                <div style="opacity: 0.8; color: white;">Active Alerts</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(124, 58, 237, 0.1)); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 15px; padding: 20px; text-align: center;">
                <div style="font-size: 2rem; font-weight: 700; color: #8b5cf6; margin-bottom: 10px;" id="triggered-alerts-count">0</div>
                <div style="opacity: 0.8; color: white;">Triggered Today</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1)); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 15px; padding: 20px; text-align: center;">
                <div style="font-size: 2rem; font-weight: 700; color: #f59e0b; margin-bottom: 10px;" id="alert-accuracy">0%</div>
                <div style="opacity: 0.8; color: white;">Accuracy Rate</div>
            </div>
        </div>

        <!-- Recent Alerts -->
        <div style="background: rgba(255,255,255,0.05); border-radius: 15px; padding: 25px; margin-bottom: 30px;">
            <h4 style="margin-bottom: 20px; color: white;">ðŸ”” Recent Alert Activity</h4>
            <div id="recent-alerts-container">
                <div style="text-align: center; opacity: 0.6; padding: 40px;">
                    <div style="font-size: 1.2rem; margin-bottom: 10px;">No recent alerts</div>
                    <div>Create alerts for stocks you're watching to get notified of important price movements</div>
                </div>
            </div>
        </div>

        <!-- Alert Tips -->
        <div style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(8, 145, 178, 0.1)); border: 1px solid rgba(6, 182, 212, 0.3); border-radius: 15px; padding: 25px;">
            <h4 style="margin-bottom: 20px; color: #06b6d4;">ðŸ’¡ Smart Alert Tips</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #10b981;">ðŸ“ˆ Price Breakouts</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; color: white;">Set alerts above resistance levels to catch momentum trades</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #f59e0b;">ðŸ”¥ Volume Spikes</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; color: white;">Monitor unusual volume for early detection of big moves</div>
                </div>
                <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px;">
                    <div style="font-weight: 600; margin-bottom: 8px; color: #8b5cf6;">ðŸ›’ Buying Opportunities</div>
                    <div style="font-size: 0.9rem; opacity: 0.8; color: white;">Set alerts below support to catch potential dips</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Alert management functions
async function checkAllAlerts() {
    try {
        showAlertNotification('Checking all alerts...', 'info');
        
        const response = await fetch('/api/alerts/check', {
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success) {
            if (data.triggered_alerts.length > 0) {
                showAlertNotification(`${data.triggered_alerts.length} alerts triggered!`, 'success');
                updateTriggeredAlertsCount(data.triggered_alerts.length);
            } else {
                showAlertNotification('No alerts triggered', 'info');
            }
            loadRecentAlerts(); // Refresh the display
        } else {
            showAlertNotification('Error checking alerts', 'error');
        }
    } catch (error) {
        console.error('Error checking alerts:', error);
        showAlertNotification('Error checking alerts', 'error');
    }
}

async function viewActiveAlerts() {
    try {
        const response = await fetch('/api/alerts/active', {
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success) {
            displayActiveAlertsModal(data.alerts);
        } else {
            showAlertNotification('Error loading alerts', 'error');
        }
    } catch (error) {
        console.error('Error loading active alerts:', error);
        showAlertNotification('Error loading alerts', 'error');
    }
}

function displayActiveAlertsModal(alerts) {
    const modal = document.createElement('div');
    modal.id = 'active-alerts-modal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
        overflow-y: auto;
    `;
    
    modal.innerHTML = `
        <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 30px; border-radius: 15px; width: 95%; max-width: 700px; color: white; box-shadow: 0 20px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                <h3 style="margin: 0; font-size: 1.5rem;">Active Alerts (${alerts.length})</h3>
                <button onclick="closeActiveAlertsModal()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            
            <div style="margin-bottom: 20px;">
                ${alerts.length > 0 ? 
                    alerts.map(alert => `
                        <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 20px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <div>
                                    <div style="font-weight: 600; font-size: 1.1rem;">${alert.company_name} (${alert.symbol})</div>
                                    <div style="opacity: 0.7; font-size: 0.9rem;">Current: $${alert.current_price ? alert.current_price.toFixed(2) : 'N/A'}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.8rem; opacity: 0.6;">Created: ${new Date(alert.created_at).toLocaleDateString()}</div>
                                    <div style="background: ${alert.active ? '#10b981' : '#6b7280'}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; margin-top: 5px;">
                                        ${alert.active ? 'Active' : 'Paused'}
                                    </div>
                                </div>
                            </div>
                            <div style="border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;">
                                <div style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 10px;">Alert Conditions:</div>
                                ${alert.conditions ? alert.conditions.map(condition => `
                                    <div style="background: rgba(255,255,255,0.02); border-radius: 6px; padding: 10px; margin-bottom: 8px; font-size: 0.9rem;">
                                        <div style="font-weight: 600; margin-bottom: 5px;">${condition.title || 'Alert Condition'}</div>
                                        <div style="opacity: 0.7;">${condition.description || 'Custom condition'}</div>
                                    </div>
                                `).join('') : '<div style="opacity: 0.6;">No conditions configured</div>'}
                            </div>
                            ${alert.status ? `
                                <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                                    <div style="font-size: 0.8rem; opacity: 0.7;">
                                        ${alert.status.closest_trigger ? `Next trigger: ${alert.status.closest_trigger}` : 'No pending triggers'}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `).join('') 
                    : '<div style="text-align: center; opacity: 0.6; padding: 40px;">No active alerts</div>'
                }
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function closeActiveAlertsModal() {
    const modal = document.getElementById('active-alerts-modal');
    if (modal) {
        modal.remove();
    }
}

async function loadRecentAlerts() {
    try {
        const response = await fetch('/api/alerts/active', {
            credentials: 'same-origin'
        });
        const data = await response.json();
        
        if (data.success) {
            updateAlertStats(data.alerts);
            displayRecentAlerts(data.alerts.slice(0, 5)); // Show last 5 alerts
        }
    } catch (error) {
        console.error('Error loading recent alerts:', error);
    }
}

function updateAlertStats(alerts) {
    const activeCount = alerts.filter(alert => alert.active).length;
    const triggeredCount = alerts.filter(alert => alert.triggered_conditions && alert.triggered_conditions.length > 0).length;
    const accuracy = alerts.length > 0 ? Math.round((triggeredCount / alerts.length) * 100) : 0;
    
    document.getElementById('active-alerts-count').textContent = activeCount;
    document.getElementById('triggered-alerts-count').textContent = triggeredCount;
    document.getElementById('alert-accuracy').textContent = accuracy + '%';
}

function updateTriggeredAlertsCount(count) {
    const currentCount = parseInt(document.getElementById('triggered-alerts-count').textContent);
    document.getElementById('triggered-alerts-count').textContent = currentCount + count;
}

function displayRecentAlerts(alerts) {
    const container = document.getElementById('recent-alerts-container');
    
    if (alerts.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; opacity: 0.6; padding: 40px;">
                <div style="font-size: 1.2rem; margin-bottom: 10px;">No recent alerts</div>
                <div>Create alerts for stocks you're watching to get notified of important price movements</div>
            </div>
        `;
        return;
    }
    
    container.innerHTML = alerts.map(alert => `
        <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 15px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div style="font-weight: 600; margin-bottom: 5px;">${alert.symbol} - ${alert.company_name}</div>
                    <div style="font-size: 0.9rem; opacity: 0.7;">
                        ${alert.conditions && alert.conditions.length > 0 ? alert.conditions[0].title : 'Custom Alert'}
                    </div>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.9rem; color: #10b981;">$${alert.current_price ? alert.current_price.toFixed(2) : 'N/A'}</div>
                    <div style="font-size: 0.8rem; opacity: 0.6;">${new Date(alert.created_at).toLocaleDateString()}</div>
                </div>
            </div>
        </div>
    `).join('');
}

function showAlertNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#8b5cf6'};
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        z-index: 10000;
        box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// Load alerts when the tab is activated
document.addEventListener('DOMContentLoaded', function() {
    if (document.getElementById('alerts-content')) {
        loadRecentAlerts();
    }
});

// Add CSS for animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);
</script>