<!-- Institutional-Grade Features Modal -->
<div class="modal fade" id="institutionalFeaturesModal" tabindex="-1" aria-labelledby="institutionalFeaturesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="institutionalFeaturesModalLabel">
                    <i class="fas fa-university me-2"></i>
                    Institutional-Grade Trading Features
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Feature Tabs -->
                <ul class="nav nav-tabs mb-4" id="institutionalTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="smart-order-tab" data-bs-toggle="tab" data-bs-target="#smart-order" type="button" role="tab">
                            <i class="fas fa-route me-2"></i>Smart Order Routing
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="level2-tab" data-bs-toggle="tab" data-bs-target="#level2" type="button" role="tab">
                            <i class="fas fa-layer-group me-2"></i>Level 2 Data
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="options-flow-tab" data-bs-toggle="tab" data-bs-target="#options-flow" type="button" role="tab">
                            <i class="fas fa-chart-line me-2"></i>Options Flow
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="dark-pool-tab" data-bs-toggle="tab" data-bs-target="#dark-pool" type="button" role="tab">
                            <i class="fas fa-eye-slash me-2"></i>Dark Pool Intelligence
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="algo-trading-tab" data-bs-toggle="tab" data-bs-target="#algo-trading" type="button" role="tab">
                            <i class="fas fa-robot me-2"></i>Algorithm Builder
                        </button>
                    </li>
                </ul>

                <!-- Tab Content -->
                <div class="tab-content" id="institutionalTabContent">
                    <!-- Smart Order Routing -->
                    <div class="tab-pane fade show active" id="smart-order" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>Professional Smart Order Routing</h6>
                                <p class="text-muted">Automatically find the best execution across 50+ venues including NYSE, NASDAQ, ARCA, BATS, and IEX.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Stock Symbol</label>
                                    <input type="text" class="form-control bg-dark text-white" id="sorSymbol" placeholder="Enter symbol (e.g., AAPL)">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" class="form-control bg-dark text-white" id="sorQuantity" value="100">
                                </div>
                                <button class="btn btn-primary" onclick="analyzeSOR()">
                                    <i class="fas fa-search me-2"></i>Analyze Optimal Execution
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div id="sorResults" class="d-none">
                                    <h6>Execution Analysis</h6>
                                    <div class="card bg-secondary">
                                        <div class="card-body">
                                            <div class="mb-2">
                                                <strong>Recommended Venue:</strong> <span id="sorVenue" class="text-success"></span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Execution Score:</strong> <span id="sorScore" class="text-warning"></span>/1.0
                                            </div>
                                            <div class="mb-2">
                                                <strong>Estimated Fee:</strong> $<span id="sorFee"></span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Market Impact:</strong> <span id="sorImpact"></span>%
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Level 2 Data -->
                    <div class="tab-pane fade" id="level2" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>Level 2 Market Data</h6>
                                <p class="text-muted">Professional order book analysis with bid/ask depth and market maker activity.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Stock Symbol</label>
                                    <input type="text" class="form-control bg-dark text-white" id="level2Symbol" placeholder="Enter symbol (e.g., TSLA)">
                                </div>
                                <button class="btn btn-primary" onclick="analyzeLevel2()">
                                    <i class="fas fa-chart-bar me-2"></i>Get Order Book Data
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div id="level2Results" class="d-none">
                                    <h6>Order Book Analysis</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="card bg-success bg-opacity-10">
                                                <div class="card-body text-center">
                                                    <h6 class="text-success">Bids</h6>
                                                    <div id="bidDepth" class="h5"></div>
                                                    <small>5-Level Depth</small>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="card bg-danger bg-opacity-10">
                                                <div class="card-body text-center">
                                                    <h6 class="text-danger">Asks</h6>
                                                    <div id="askDepth" class="h5"></div>
                                                    <small>5-Level Depth</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="d-flex justify-content-between">
                                            <span>Spread:</span>
                                            <span id="spreadValue" class="text-warning"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Liquidity Score:</span>
                                            <span id="liquidityScore" class="text-info"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Options Flow -->
                    <div class="tab-pane fade" id="options-flow" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>Options Flow Analysis</h6>
                                <p class="text-muted">Track unusual institutional options activity and large block trades.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Stock Symbol</label>
                                    <input type="text" class="form-control bg-dark text-white" id="optionsSymbol" placeholder="Enter symbol (e.g., NVDA)">
                                </div>
                                <button class="btn btn-primary" onclick="analyzeOptionsFlow()">
                                    <i class="fas fa-chart-line me-2"></i>Analyze Options Activity
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div id="optionsResults" class="d-none">
                                    <h6>Unusual Activity Detected</h6>
                                    <div id="unusualActivity"></div>
                                    <div class="mt-3">
                                        <h6>Flow Summary</h6>
                                        <div class="d-flex justify-content-between">
                                            <span>Call/Put Ratio:</span>
                                            <span id="callPutRatio" class="text-warning"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Bullish Flow:</span>
                                            <span id="bullishFlow" class="text-success"></span>
                                        </div>
                                        <div class="d-flex justify-content-between">
                                            <span>Bearish Flow:</span>
                                            <span id="bearishFlow" class="text-danger"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Dark Pool Intelligence -->
                    <div class="tab-pane fade" id="dark-pool" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>Dark Pool Intelligence</h6>
                                <p class="text-muted">Monitor institutional block trading activity across major dark pools.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Stock Symbol</label>
                                    <input type="text" class="form-control bg-dark text-white" id="darkPoolSymbol" placeholder="Enter symbol (e.g., AMZN)">
                                </div>
                                <button class="btn btn-primary" onclick="analyzeDarkPool()">
                                    <i class="fas fa-eye-slash me-2"></i>Analyze Dark Pool Activity
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div id="darkPoolResults" class="d-none">
                                    <h6>Institutional Activity</h6>
                                    <div class="card bg-secondary">
                                        <div class="card-body">
                                            <div class="mb-2">
                                                <strong>Dark Volume:</strong> <span id="darkVolume" class="text-warning"></span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Major Venues:</strong>
                                                <div id="darkPools" class="mt-2"></div>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Block Trades:</strong>
                                                <div id="blockTrades" class="mt-2"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Algorithm Builder -->
                    <div class="tab-pane fade" id="algo-trading" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>Algorithm Builder & Backtesting</h6>
                                <p class="text-muted">Create and test custom trading strategies with professional backtesting.</p>
                                
                                <div class="mb-3">
                                    <label class="form-label">Strategy Name</label>
                                    <input type="text" class="form-control bg-dark text-white" id="strategyName" placeholder="My Trading Strategy">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Test Symbol</label>
                                    <input type="text" class="form-control bg-dark text-white" id="algoSymbol" placeholder="Enter symbol (e.g., MSFT)">
                                </div>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label">Start Date</label>
                                        <input type="date" class="form-control bg-dark text-white" id="startDate" value="2024-01-01">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label">End Date</label>
                                        <input type="date" class="form-control bg-dark text-white" id="endDate" value="2024-12-31">
                                    </div>
                                </div>
                                <button class="btn btn-primary mt-3" onclick="backtestStrategy()">
                                    <i class="fas fa-play me-2"></i>Run Backtest
                                </button>
                            </div>
                            <div class="col-md-6">
                                <div id="backtestResults" class="d-none">
                                    <h6>Backtest Results</h6>
                                    <div class="card bg-secondary">
                                        <div class="card-body">
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="text-center">
                                                        <div class="h4" id="totalReturn">+0%</div>
                                                        <small>Total Return</small>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="text-center">
                                                        <div class="h4" id="sharpeRatio">0.0</div>
                                                        <small>Sharpe Ratio</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mt-3">
                                                <div class="d-flex justify-content-between">
                                                    <span>Win Rate:</span>
                                                    <span id="winRate" class="text-success">0%</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>Max Drawdown:</span>
                                                    <span id="maxDrawdown" class="text-danger">0%</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>Total Trades:</span>
                                                    <span id="totalTrades">0</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="upgradeForInstitutionalFeatures()">
                    <i class="fas fa-crown me-2"></i>Upgrade to Elite
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Institutional Features JavaScript Functions

async function analyzeSOR() {
    const symbol = document.getElementById('sorSymbol').value;
    const quantity = document.getElementById('sorQuantity').value;
    
    if (!symbol) {
        alert('Please enter a stock symbol');
        return;
    }
    
    try {
        const response = await fetch(`/api/institutional/smart-order-routing/${symbol}?quantity=${quantity}`);
        const data = await response.json();
        
        if (data.error) {
            if (data.error.includes('Premium subscription required')) {
                upgradeForInstitutionalFeatures();
            } else {
                alert('Error: ' + data.error);
            }
            return;
        }
        
        // Display results
        document.getElementById('sorVenue').textContent = data.recommended_venue;
        document.getElementById('sorScore').textContent = data.execution_score;
        document.getElementById('sorFee').textContent = data.estimated_fee.toFixed(2);
        document.getElementById('sorImpact').textContent = data.market_impact;
        
        document.getElementById('sorResults').classList.remove('d-none');
    } catch (error) {
        console.error('SOR Analysis error:', error);
        alert('Failed to analyze smart order routing');
    }
}

async function analyzeLevel2() {
    const symbol = document.getElementById('level2Symbol').value;
    
    if (!symbol) {
        alert('Please enter a stock symbol');
        return;
    }
    
    try {
        const response = await fetch(`/api/institutional/level2-data/${symbol}`);
        const data = await response.json();
        
        if (data.error) {
            if (data.error.includes('Premium subscription required')) {
                upgradeForInstitutionalFeatures();
            } else {
                alert('Error: ' + data.error);
            }
            return;
        }
        
        // Display results
        document.getElementById('bidDepth').textContent = data.market_depth.bid_depth_5.toLocaleString();
        document.getElementById('askDepth').textContent = data.market_depth.ask_depth_5.toLocaleString();
        document.getElementById('spreadValue').textContent = '$' + data.bid_ask_spread.toFixed(4);
        document.getElementById('liquidityScore').textContent = (data.market_depth.liquidity_score * 100).toFixed(1) + '%';
        
        document.getElementById('level2Results').classList.remove('d-none');
    } catch (error) {
        console.error('Level 2 analysis error:', error);
        alert('Failed to analyze Level 2 data');
    }
}

async function analyzeOptionsFlow() {
    const symbol = document.getElementById('optionsSymbol').value;
    
    if (!symbol) {
        alert('Please enter a stock symbol');
        return;
    }
    
    try {
        const response = await fetch(`/api/institutional/options-flow/${symbol}`);
        const data = await response.json();
        
        if (data.error) {
            if (data.error.includes('Premium subscription required')) {
                upgradeForInstitutionalFeatures();
            } else {
                alert('Error: ' + data.error);
            }
            return;
        }
        
        // Display unusual activity
        const activityHtml = data.unusual_activity.slice(0, 3).map(activity => `
            <div class="alert alert-warning py-2 mb-2">
                <small>
                    <strong>${activity.type}</strong> ${activity.strike} exp ${activity.expiration}<br>
                    Volume: ${activity.volume.toLocaleString()} | Premium: $${activity.premium.toFixed(2)}
                </small>
            </div>
        `).join('');
        
        document.getElementById('unusualActivity').innerHTML = activityHtml;
        document.getElementById('callPutRatio').textContent = data.flow_summary.call_put_ratio;
        document.getElementById('bullishFlow').textContent = '$' + (data.flow_summary.bullish_flow / 1000).toFixed(1) + 'K';
        document.getElementById('bearishFlow').textContent = '$' + (data.flow_summary.bearish_flow / 1000).toFixed(1) + 'K';
        
        document.getElementById('optionsResults').classList.remove('d-none');
    } catch (error) {
        console.error('Options flow analysis error:', error);
        alert('Failed to analyze options flow');
    }
}

async function analyzeDarkPool() {
    const symbol = document.getElementById('darkPoolSymbol').value;
    
    if (!symbol) {
        alert('Please enter a stock symbol');
        return;
    }
    
    try {
        const response = await fetch(`/api/dark-pool/activity/${symbol}`);
        const data = await response.json();
        
        if (data.error) {
            if (data.error.includes('Premium subscription required')) {
                upgradeForInstitutionalFeatures();
            } else {
                alert('Error: ' + data.error);
            }
            return;
        }
        
        // Display results
        document.getElementById('darkVolume').textContent = data.total_dark_volume.toLocaleString();
        
        // Show top dark pools
        const poolsHtml = data.dark_pools.slice(0, 3).map(pool => `
            <div class="small mb-1">
                <strong>${pool.venue}:</strong> ${pool.size.toLocaleString()} shares @ $${pool.price}
            </div>
        `).join('');
        document.getElementById('darkPools').innerHTML = poolsHtml;
        
        // Show block trades
        const tradesHtml = data.block_trades.slice(0, 2).map(trade => `
            <div class="small mb-1">
                <span class="badge bg-${trade.direction === 'BUY' ? 'success' : 'danger'}">${trade.direction}</span>
                ${trade.size.toLocaleString()} @ $${trade.price}
            </div>
        `).join('');
        document.getElementById('blockTrades').innerHTML = tradesHtml;
        
        document.getElementById('darkPoolResults').classList.remove('d-none');
    } catch (error) {
        console.error('Dark pool analysis error:', error);
        alert('Failed to analyze dark pool activity');
    }
}

async function backtestStrategy() {
    const symbol = document.getElementById('algoSymbol').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!symbol || !startDate || !endDate) {
        alert('Please fill in all required fields');
        return;
    }
    
    try {
        const response = await fetch('/api/algorithm/backtest-advanced', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                symbol: symbol,
                strategy: { name: 'Simple Moving Average Crossover' },
                start_date: startDate,
                end_date: endDate,
                initial_capital: 100000
            })
        });
        
        const data = await response.json();
        
        if (data.error) {
            if (data.error.includes('Premium subscription required')) {
                upgradeForInstitutionalFeatures();
            } else {
                alert('Error: ' + data.error);
            }
            return;
        }
        
        // Display results
        const returnPct = (data.total_return * 100).toFixed(1);
        document.getElementById('totalReturn').textContent = (returnPct >= 0 ? '+' : '') + returnPct + '%';
        document.getElementById('totalReturn').className = 'h4 ' + (returnPct >= 0 ? 'text-success' : 'text-danger');
        
        document.getElementById('sharpeRatio').textContent = data.sharpe_ratio.toFixed(2);
        document.getElementById('winRate').textContent = (data.win_rate * 100).toFixed(1) + '%';
        document.getElementById('maxDrawdown').textContent = (data.max_drawdown * 100).toFixed(1) + '%';
        document.getElementById('totalTrades').textContent = data.total_trades;
        
        document.getElementById('backtestResults').classList.remove('d-none');
    } catch (error) {
        console.error('Backtesting error:', error);
        alert('Failed to run backtest');
    }
}

function upgradeForInstitutionalFeatures() {
    // Close institutional features modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('institutionalFeaturesModal'));
    if (modal) modal.hide();
    
    // Show premium modal
    if (typeof showPremiumModal === 'function') {
        showPremiumModal();
    } else {
        alert('Upgrade to Elite plan to access institutional-grade features!');
    }
}
</script>