<!-- Buy Stock Modal -->
<div id="buy-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
    <div style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border-radius: 20px; padding: 40px; width: 90%; max-width: 500px; color: white; box-shadow: 0 25px 50px rgba(0,0,0,0.5);">
        <h2 style="margin-bottom: 30px; text-align: center; color: #10b981;">Buy Stock</h2>
        
        <div id="stock-info" style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 20px; margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <div id="buy-stock-name" style="font-size: 1.2rem; font-weight: 600;"></div>
                    <div id="buy-stock-symbol" style="opacity: 0.7; margin-top: 5px;"></div>
                </div>
                <div style="text-align: right;">
                    <div id="buy-stock-price" style="font-size: 1.5rem; font-weight: 700; color: #10b981;"></div>
                    <div id="buy-stock-change" style="font-size: 0.9rem;"></div>
                </div>
            </div>
        </div>
        
        <form id="buyForm" onsubmit="handleBuyStock(event)">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; opacity: 0.8;">Number of Shares</label>
                <input type="number" id="shares" name="shares" min="1" value="1" required style="width: 100%; padding: 15px; border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; background: rgba(255,255,255,0.05); color: white; font-size: 16px; outline: none;">
            </div>
            
            <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 20px; margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Price per Share:</span>
                    <span id="price-per-share">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <span>Total Cost:</span>
                    <span id="total-cost" style="font-weight: 700; color: #10b981;">$0.00</span>
                </div>
                <div style="display: flex; justify-content: space-between; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; margin-top: 15px;">
                    <span>Account Balance:</span>
                    <span id="account-balance" style="font-weight: 700;">$100,000.00</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 15px;">
                <button type="button" onclick="closeBuyModal()" style="flex: 1; padding: 15px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; color: white; cursor: pointer;">
                    Cancel
                </button>
                <button type="submit" id="buy-btn" style="flex: 2; padding: 15px; background: linear-gradient(45deg, #10b981, #059669); border: none; border-radius: 10px; color: white; font-weight: 600; cursor: pointer;">
                    Buy Stock
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let currentStock = null;

function showBuyModal() {
    if (!currentStock) {
        alert('Please search for a stock first');
        return;
    }
    
    // Populate stock info
    document.getElementById('buy-stock-name').textContent = currentStock.name;
    document.getElementById('buy-stock-symbol').textContent = currentStock.symbol;
    document.getElementById('buy-stock-price').textContent = `$${currentStock.price.toFixed(2)}`;
    
    const changeClass = currentStock.change >= 0 ? '#10b981' : '#ef4444';
    const changeSymbol = currentStock.change >= 0 ? '+' : '';
    document.getElementById('buy-stock-change').innerHTML = `<span style="color: ${changeClass}">${changeSymbol}$${Math.abs(currentStock.change).toFixed(2)} (${changeSymbol}${currentStock.change_percent.toFixed(2)}%)</span>`;
    
    updateCalculations();
    document.getElementById('buy-modal').style.display = 'flex';
}

function closeBuyModal() {
    document.getElementById('buy-modal').style.display = 'none';
}

function updateCalculations() {
    const shares = parseInt(document.getElementById('shares').value) || 0;
    const pricePerShare = currentStock ? currentStock.price : 0;
    const totalCost = shares * pricePerShare;
    
    document.getElementById('price-per-share').textContent = `$${pricePerShare.toFixed(2)}`;
    document.getElementById('total-cost').textContent = `$${totalCost.toFixed(2)}`;
}

// Update calculations when shares change
document.addEventListener('DOMContentLoaded', function() {
    const sharesInput = document.getElementById('shares');
    if (sharesInput) {
        sharesInput.addEventListener('input', updateCalculations);
    }
});

async function handleBuyStock(event) {
    event.preventDefault();
    
    const shares = parseInt(document.getElementById('shares').value);
    const totalCost = shares * currentStock.price;
    
    if (totalCost > 100000) { // Simple balance check
        alert('Insufficient funds');
        return;
    }
    
    try {
        const response = await fetch('/api/buy-stock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                symbol: currentStock.symbol,
                shares: shares,
                price: currentStock.price
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Successfully purchased ${shares} shares of ${currentStock.symbol} for $${totalCost.toFixed(2)}`);
            closeBuyModal();
            // Update account balance
            document.getElementById('account-balance').textContent = `$${(100000 - totalCost).toFixed(2)}`;
        } else {
            alert(data.error || 'Purchase failed');
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}
</script>